<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯€æ‹å™¨ (Metronome)</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®š Inter å­—é«”ï¼Œä»¥åŠæ‡‰ç”¨ç¨‹å¼çš„èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯ */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px; /* ä¿®æ­£ï¼šå¢åŠ å‚ç›´å…§é‚Šè·ä»¥é¿å…å…§å®¹è¢«åˆ‡æ–· */
            overflow-y: auto; /* å…è¨±å…§å®¹æº¢å‡ºæ™‚æ»¾å‹• */
            /* ç¦ç”¨æ–‡å­—åç™½é¸å–åŠŸèƒ½ */
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* è‡ªè¨‚æŒ‰éˆ•æ¨£å¼ */
        .metronome-button {
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
        }

        .metronome-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .metronome-button:active {
            opacity: 0.7;
            transform: translateY(1px);
        }

        /* ç¯€æ‹å™¨å¡ç‰‡ */
        .metronome-card {
            background-color: #2c2a4a;
            border: 1px solid #4a4768;
            transition: transform 0.2s;
            max-width: 420px;
            width: 100%;
        }

        /* ç¯€æ‹æŒ‡ç¤ºç‡ˆï¼šä½¿ç”¨ transition è®“é–ƒçˆæ›´å¹³æ»‘ */
        .beat-indicator {
            transition: all 0.05s ease-out; /* å¿«é€Ÿé–ƒçˆå‹•ç•« */
            will-change: transform, background-color;
        }

        /* éš±è—é è¨­çš„ input number ç®­é ­ï¼Œä¸¦å…è¨±æ–‡å­—é¸å– */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            user-select: auto; /* å…è¨±åœ¨è¼¸å…¥æ¡†å…§é¸å–æ–‡å­— */
        }
        
        /* å…¨è¢å¹•è¦–è¦ºåŒ–æ¨¡å¼ CSS */
        .full-screen-vis {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #111; 
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            z-index: 1000;
            color: #333; /* é è¨­æš—ç°è‰² */
        }

        .vis-item {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30vw; /* å·¨å¤§æ–‡å­— */
            font-weight: 900;
            cursor: pointer;
            transition: color 0.05s, transform 0.05s;
            will-change: color, transform;
            user-select: none;
        }
        .vis-item.highlight-strong {
            color: #ffffff; /* å¼·æ‹äº®ç™½è‰² */
            transform: scale(1.05);
        }
        .vis-item.highlight-weak {
            color: #cccccc; /* å¼±æ‹äº®ç°è‰² */
            transform: scale(1.05);
        }
        /* è±¡é™é †åº: 1:å·¦ä¸Š, 2:å³ä¸Š, 4:å·¦ä¸‹, 3:å³ä¸‹ */
        .vis-item[data-beat="1"] { grid-area: 1 / 1 / 2 / 2; }
        .vis-item[data-beat="2"] { grid-area: 1 / 2 / 2 / 3; }
        .vis-item[data-beat="4"] { grid-area: 2 / 1 / 3 / 2; }
        .vis-item[data-beat="3"] { grid-area: 2 / 2 / 3 / 3; }
    </style>
</head>
<body>

<!-- ç¯€æ‹å™¨ä¸»ç•«é¢ (App Container) -->
<div id="app" class="metronome-card p-6 md:p-8 rounded-xl shadow-2xl text-center">
    <!-- æ¨™é¡Œ -->
    <h1 class="text-3xl font-extrabold mb-6 text-[#9a7dff]">
        ğŸµ æ•¸ä½ç¯€æ‹å™¨
    </h1>

    <!-- ç¯€æ‹é¡¯ç¤ºå€ -->
    <div class="mb-8">
        <span id="bpmDisplay" class="text-7xl font-mono font-bold text-white transition-colors duration-200">
            120
        </span>
        <div class="text-lg text-gray-400 mt-1">
            BPM
        </div>
    </div>

    <!-- BPM æ§åˆ¶å€ -->
    <div class="flex items-center justify-center space-x-4 mb-8">
        <!-- æ¸›å°‘ BPM æŒ‰éˆ• -->
        <button onclick="changeBPM(-1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-3 rounded-full text-2xl font-bold w-12 h-12 flex items-center justify-center">
            âˆ’
        </button>
        
        <!-- BPM è¼¸å…¥æ¡† -->
        <input type="number" id="bpmInput" value="120" min="40" max="240"
               onchange="updateBPM(this.value)"
               class="w-24 text-center text-3xl font-bold bg-[#4a4768] p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#9a7dff] transition-all duration-150 border border-[#6a5acd]">

        <!-- å¢åŠ  BPM æŒ‰éˆ• -->
        <button onclick="changeBPM(1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-3 rounded-full text-2xl font-bold w-12 h-12 flex items-center justify-center">
            ï¼‹
        </button>
    </div>

    <!-- æŒ‰éˆ•å®¹å™¨: Fullscreen Lock, Start/Stop & Drum Toggle -->
    <div class="flex space-x-2 mb-6 justify-center">
        <!-- Fullscreen Lock Toggle (å°å¢¨é¡/é–‹çœ¼/é–‰çœ¼) -->
        <button id="fullscreenLockToggle" onclick="toggleFullscreenLock()"
                title="é–å®š/è§£é–å…¨è¢å¹•æ¨¡å¼ (F)"
                class="metronome-button w-1/5 py-4 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
            <!-- é–‰çœ¼ (é è¨­: å…è¨±è‡ªå‹•å…¨è¢å¹•) -->
            <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-closed-icon lucide-eye-closed text-gray-400 transition-colors duration-150">
                <path d="m15 18-.722-3.25"/><path d="M2 8a10.645 10.645 0 0 0 20 0"/><path d="m20 15-1.726-2.05"/><path d="m4 15 1.726-2.05"/><path d="m9 18 .722-3.25"/>
            </svg>
        </button>

        <!-- é–‹å§‹/åœæ­¢ æŒ‰éˆ• -->
        <button id="startButton" onclick="startStop()"
                class="metronome-button w-3/5 py-4 text-xl font-bold rounded-xl bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-700">
            é–‹å§‹
        </button>
        <!-- Drum Mode Toggle -->
        <button id="drumModeToggle" onclick="toggleDrumMode()"
                title="åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)"
                class="metronome-button w-1/5 py-4 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
            <!-- é¼“åœ–ç¤º (Custom SVG) -->
            <svg id="drumIcon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-drum-icon lucide-drum text-gray-400 transition-colors duration-150">
                <path d="m2 2 8 8"/><path d="m22 2-8 8"/><ellipse cx="12" cy="9" rx="10" ry="5"/><path d="M7 13.4v7.9"/><path d="M12 14v8"/><path d="M17 13.4v7.9"/><path d="M2 9v8a10 5 0 0 0 20 0V9"/>
            </svg>
        </button>
    </div>

    <!-- Tap Tempo å€åŸŸ -->
    <div id="tapTempoArea" 
         onclick="handleTap()"
         class="p-3 bg-[#4a4768] rounded-xl cursor-pointer hover:bg-[#5a577d] transition-colors mb-6 border border-dashed border-[#6a5acd] active:scale-[0.99]">
        <p class="text-base font-semibold text-gray-200 uppercase tracking-wider">
            TAP TEMPO
        </p>
        <p id="tapTempoInfo" class="text-xs text-gray-400 mt-1 h-3">
            é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹
        </p>
    </div>
    
    <!-- ç¯€æ‹æŒ‡ç¤ºç‡ˆ (4/4 æ‹) -->
    <div id="beatIndicators" class="flex justify-around mt-6">
        <div data-beat="1" data-index="0" onclick="toggleSubdivision(0)" class="beat-indicator w-12 h-12 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer transform scale-100">
            <span class="absolute font-bold text-white mode-text text-lg">1</span>
        </div>
        <div data-beat="2" data-index="1" onclick="toggleSubdivision(1)" class="beat-indicator w-12 h-12 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer transform scale-100">
            <span class="absolute font-bold text-white mode-text text-lg">1</span>
        </div>
        <div data-beat="3" data-index="2" onclick="toggleSubdivision(2)" class="beat-indicator w-12 h-12 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer transform scale-100">
            <span class="absolute font-bold text-white mode-text text-lg">1</span>
        </div>
        <div data-beat="4" data-index="3" onclick="toggleSubdivision(3)" class="beat-indicator w-12 h-12 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer transform scale-100">
            <span class="absolute font-bold text-white mode-text text-lg">1</span>
        </div>
    </div>
    
</div>


<script>
    // Web Audio API ç›¸é—œè®Šæ•¸
    let audioContext;
    let isPlaying = false;
    let lookahead = 25.0; // å¦‚ä½•æå‰æ’ç¨‹ (ms)
    let scheduleAheadTime = 0.1; // æå‰æ’ç¨‹çš„ç§’æ•¸ (s)
    let nextNoteTime = 0.0; // ä¸‹ä¸€å€‹ç¯€æ‹çš„æ™‚é–“é»

    // ç¯€æ‹å™¨ç‹€æ…‹è®Šæ•¸
    let bpm = 120;
    const beatsPerMeasure = 4; // é è¨­ 4/4 æ‹
    let currentBeat = 0; 
    let isDrumMode = false; 
    let isFullscreenDisabled = false; // é–å®šå…¨è¢å¹•æ¨¡å¼
    
    // æ¯å€‹ç¯€æ‹çš„ç´°åˆ†æ¨¡å¼ (0: 1x, 1: 2x, 2: 4x, 3: ä¸‰é€£éŸ³, 4: Mute)
    let beatSubdivisions = new Array(beatsPerMeasure).fill(0); 
    
    // Auto Fullscreen è®Šæ•¸
    const AUTO_FULLSCREEN_DELAY = 3000; 
    let autoFullscreenTimeout = null;
    let isVisualizationActive = false; // è¿½è¹¤å…¨è¢å¹•æ˜¯å¦é–‹å•Ÿ

    // Tap Tempo è®Šæ•¸
    let tapHistory = [];
    const TAP_RESET_THRESHOLD = 2000; 
    
    // æ¨¡å¼æ¨™ç±¤ç”¨æ–¼ UI é¡¯ç¤º
    const SUBDIVISION_LABELS = {
        0: `<span class="text-lg font-extrabold relative top-[-1px]">1</span>`, 
        1: `<span class="text-lg font-extrabold relative top-[-1px]">2</span>`, 
        2: `<span class="text-lg font-extrabold relative top-[-1px]">4</span>`, 
        3: `<span class="text-lg font-extrabold relative top-[-1px]">3</span>`, 
        4: `<span class="text-xl font-extrabold text-red-500">M</span>`, 
    };
    
    // éŸ³è‰²å¸¸æ•¸
    const DRUM_KICK_FREQ = 80.0;     
    const DRUM_SNARE_FREQ = 200.0;   
    const DRUM_SNARE_DURATION = 0.1; 
    const METRONOME_STRONG_FREQ = 600.0;
    const METRONROME_WEAK_FREQ = 400.0;
    const METRONOME_DURATION = 0.05; 
    const METRONOME_SUB_FREQ = 350.0; 
    const SUBDIVISION_VOLUME_MULTIPLIER = 0.8; 

    // DOM å…ƒç´ 
    const startButton = document.getElementById('startButton');
    const bpmInput = document.getElementById('bpmInput');
    const bpmDisplay = document.getElementById('bpmDisplay');
    const beatIndicators = Array.from(document.querySelectorAll('.beat-indicator'));
    const tapTempoInfo = document.getElementById('tapTempoInfo');
    const drumModeToggle = document.getElementById('drumModeToggle');
    const drumIcon = document.getElementById('drumIcon');
    const fullscreenLockToggle = document.getElementById('fullscreenLockToggle');
    const eyeIcon = document.getElementById('eyeIcon');
    
    let intervalTimer = null;
    
    /**
     * åˆå§‹è¼‰å…¥è¨­å®šã€‚
     */
    function initApp() {
        // è¨­å®šåˆå§‹ BPM
        updateBPM(bpm);
        updateFullscreenLockIcon();
        updateDrumModeIcon();
        updateSubdivisionLabels();
    }
    
    /**
     * åˆå§‹åŒ– AudioContextã€‚
     */
    function initializeAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    /**
     * åœ¨æŒ‡å®šæ™‚é–“æ’­æ”¾ä¸€å€‹é»æ“ŠéŸ³æ•ˆã€‚
     */
    function playClick(time, pitch, duration, volume = 1.0) {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine'; 
        oscillator.frequency.setValueAtTime(pitch, time); 

        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(volume, time); 
        gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.start(time);
        oscillator.stop(time + duration);
    }

    /**
     * è¦–è¦ºä¸Šé–ƒçˆç•¶å‰çš„ç¯€æ‹æŒ‡ç¤ºç‡ˆã€‚
     * @param {number} beat - ç•¶å‰çš„ç¯€æ‹æ•¸ (1 åˆ° beatsPerMeasure)ã€‚
     * @param {number} subdivisionMode - ç´°åˆ†æ¨¡å¼ (0=1x, 1=2x, 2=4x, 3=3x, 4=Mute)ã€‚
     * @param {number} subStep - ç´°åˆ†æ‹çš„æ­¥é©Ÿ (0 é–‹å§‹)ã€‚
     * @param {number} delay - è·é›¢æº–ç¢ºæ’­æ”¾æ™‚é–“çš„æ¯«ç§’å»¶é²ã€‚
     */
    function flashIndicator(beat, subdivisionMode, subStep, delay) {
        const animationDuration = 50; 
        
        setTimeout(() => {
            const indicator = document.querySelector(`.beat-indicator[data-beat="${beat}"]`);
            if (!indicator) return; 

            // ä¸»ç•«é¢ä¸Šæ–¹çš„åœ“é»ï¼Œç„¡è«–ç´°åˆ†æ¨¡å¼å¦‚ä½•ï¼Œéƒ½åªåœ¨ä¸»æ‹ (subStep === 0) é–ƒçˆ
            if (subStep === 0 && subdivisionMode !== 4) {
                const highlightColorClass = (beat === 1) ? 'bg-[#ff5733]' : 'bg-[#ffc300]';
                const offColorClass = 'bg-gray-600'; 
                
                indicator.classList.remove(offColorClass, 'bg-gray-900', 'opacity-50');
                indicator.classList.add(highlightColorClass, 'scale-110'); 

                setTimeout(() => {
                    indicator.classList.remove(highlightColorClass, 'scale-110');
                    indicator.classList.add(offColorClass);
                }, animationDuration);
            }
        }, delay > 0 ? delay : 0);
    }
    
    /**
     * è¦–è¦ºåŒ–ï¼šåœ¨å…¨è¢å¹•æ¨¡å¼ä¸‹æ›´æ–°ç•¶å‰çš„ç¯€æ‹ã€‚
     */
    function updateVisuals(beat, subdivisionStep) {
        if (!isVisualizationActive) return;

        const visItems = document.querySelectorAll('.vis-item');
        const currentBeatElement = document.querySelector(`.vis-item[data-beat="${beat}"]`);
        
        // åªæœ‰åœ¨ä¸»æ‹åˆ°é”æ™‚æ‰è§¸ç™¼å…¨è¢å¹•é–ƒçˆ
        const isMainFlash = (subdivisionStep === 0 || subdivisionStep === -1);
        
        if (isMainFlash) {
             // é‡ç½®æ‰€æœ‰ç¯€æ‹çš„é¡è‰²
            visItems.forEach(item => {
                item.classList.remove('highlight-strong', 'highlight-weak');
            });
            
            // é–ƒçˆç•¶å‰ç¯€æ‹
            if (currentBeatElement) {
                const highlightClass = (beat === 1) ? 'highlight-strong' : 'highlight-weak';
                currentBeatElement.classList.add(highlightClass);
                
                // å»¶é²é‡ç½®ï¼Œä¿æŒé–ƒçˆæ•ˆæœå¯è¦‹
                setTimeout(() => {
                    currentBeatElement.classList.remove(highlightClass);
                }, 100); 
            }
        }
    }


    /**
     * æ’ç¨‹ä¸‹ä¸€å€‹ç¯€æ‹ä¸¦æ›´æ–°ç‹€æ…‹ã€‚
     */
    function scheduler() {
        while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
            
            const secondsPerBeat = 60.0 / bpm;
            
            // æ¯æ¬¡æ’ç¨‹éƒ½æ›´æ–°ä¸»ç¯€æ‹
            currentBeat = (currentBeat % beatsPerMeasure) + 1;
            const beatIndex = currentBeat - 1; 
            const subdivisionMode = beatSubdivisions[beatIndex]; 

            // 1. è²éŸ³é‚è¼¯ï¼šè¨ˆç®—ç´°åˆ†æ•¸é‡
            let subdivisionCount = 1; 
            if (subdivisionMode === 1) subdivisionCount = 2;       // 2x (å…«åˆ†éŸ³ç¬¦)
            else if (subdivisionMode === 2) subdivisionCount = 4;  // 4x (åå…­åˆ†éŸ³ç¬¦)
            else if (subdivisionMode === 3) subdivisionCount = 3;  // 3x (ä¸‰é€£éŸ³)
            else if (subdivisionMode === 4) subdivisionCount = 0;  // éœéŸ³

            
            if (subdivisionCount > 0) {
                const subDuration = secondsPerBeat / subdivisionCount;

                for (let i = 0; i < subdivisionCount; i++) {
                    const clickTime = nextNoteTime + i * subDuration;
                    
                    const delay = (clickTime - audioContext.currentTime) * 1000;
                    
                    let pitch;
                    let duration;
                    let volumeMultiplier; 
                    
                    const isMainBeatClick = (i === 0);

                    if (isMainBeatClick) {
                        volumeMultiplier = 1.0; 
                        // è¦–è¦ºæ›´æ–°ï¼šåªæœ‰ä¸»æ‹åˆ°é”æ™‚æ›´æ–°å…¨è¢å¹•æ•¸å­—
                        updateVisuals(currentBeat, 0); 
                    } else {
                        volumeMultiplier = SUBDIVISION_VOLUME_MULTIPLIER;
                    }
                    
                    // è¦–è¦ºæ›´æ–°ï¼šä¸»ç•«é¢ä¸Šæ–¹çš„åœ“é»é–ƒçˆ
                    flashIndicator(currentBeat, subdivisionMode, i, delay);


                    if (isDrumMode) {
                        if (isMainBeatClick) {
                            pitch = (currentBeat === 1 || currentBeat === 3) ? DRUM_KICK_FREQ : DRUM_SNARE_FREQ;
                            duration = (currentBeat === 2 || currentBeat === 4) ? DRUM_SNARE_DURATION : METRONOME_DURATION;
                        } else {
                            pitch = 800.0; 
                            duration = METRONOME_DURATION * 0.3;
                        }
                    } else {
                        duration = METRONOME_DURATION; 
                        if (currentBeat === 1 && isMainBeatClick) {
                            pitch = METRONOME_STRONG_FREQ; 
                        } else if (isMainBeatClick) {
                            pitch = METRONROME_WEAK_FREQ; 
                        } else {
                            pitch = METRONOME_SUB_FREQ; 
                        }
                    }
                    
                    playClick(clickTime, pitch, duration, volumeMultiplier);
                }
            } else {
                // Mute Mode - ä»ç„¶æ›´æ–°å…¨è¢å¹•æ•¸å­—ï¼Œä½†è²éŸ³éœéŸ³
                updateVisuals(currentBeat, -1);
            }

            nextNoteTime += secondsPerBeat;
        }
    }

    /**
     * è™•ç†è‡ªå‹•å…¨è¢å¹•è¨ˆæ™‚å™¨ï¼Œåœ¨æ»‘é¼ é–’ç½®å¾Œé‡æ–°é€²å…¥å…¨è¢å¹•ã€‚
     */
    function resetAutoFullscreenTimeout() {
        clearTimeout(autoFullscreenTimeout);
        if (isPlaying && !isFullscreenDisabled && !isVisualizationActive) {
            autoFullscreenTimeout = setTimeout(showVisualization, AUTO_FULLSCREEN_DELAY);
        }
    }

    /**
     * é¡¯ç¤ºå…¨è¢å¹•è¦–è¦ºåŒ–æ¨¡å¼ã€‚
     */
    function showVisualization() {
        if (isVisualizationActive || !isPlaying || isFullscreenDisabled) return;

        const visDiv = document.createElement('div');
        visDiv.id = 'fullscreenVis';
        visDiv.className = 'full-screen-vis';
        visDiv.innerHTML = `
            <div data-beat="1" class="vis-item">1</div>
            <div data-beat="2" class="vis-item">2</div>
            <div data-beat="4" class="vis-item">4</div> 
            <div data-beat="3" class="vis-item">3</div>
        `;
        
        visDiv.onclick = hideVisualization;
        document.body.appendChild(visDiv);
        isVisualizationActive = true;
    }

    /**
     * éš±è—å…¨è¢å¹•è¦–è¦ºåŒ–æ¨¡å¼ã€‚
     */
    window.hideVisualization = function() {
        const visDiv = document.getElementById('fullscreenVis');
        if (visDiv) {
            visDiv.remove();
        }
        isVisualizationActive = false;
        // é»æ“Šè¿”å›å¾Œï¼Œå•Ÿå‹• 3 ç§’è‡ªå‹•å…¨è¢å¹•è¨ˆæ™‚å™¨
        resetAutoFullscreenTimeout(); 
    }

    /**
     * é–‹å§‹æˆ–åœæ­¢ç¯€æ‹å™¨ã€‚
     */
    window.startStop = function() {
        initializeAudio();

        if (isPlaying) {
            // åœæ­¢
            clearInterval(intervalTimer);
            isPlaying = false;
            hideVisualization(); // åœæ­¢æ™‚å¼·åˆ¶é€€å‡ºå…¨è¢å¹•
            clearTimeout(autoFullscreenTimeout);
            
            startButton.textContent = 'é–‹å§‹';
            startButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');
            startButton.classList.add('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            
            // é‡ç½®è¦–è¦ºæŒ‡ç¤ºç‡ˆé¡è‰²åˆ°åˆå§‹ç‹€æ…‹
            beatIndicators.forEach((indicator, index) => {
                indicator.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'scale-110');
                if (beatSubdivisions[index] !== 4) {
                    indicator.classList.add('bg-gray-600');
                } else {
                    indicator.classList.add('bg-gray-900', 'opacity-50');
                }
            });
            
            currentBeat = 0;

        } else {
            // é–‹å§‹
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            isPlaying = true;
            startButton.textContent = 'åœæ­¢';
            startButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            startButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');

            currentBeat = 0;
            nextNoteTime = audioContext.currentTime;
            
            // å»¶é² 1 ç§’é€²å…¥å…¨è¢å¹•
            if (!isFullscreenDisabled) {
                setTimeout(showVisualization, 1000); 
            }
            
            // å•Ÿå‹•æ’ç¨‹å™¨é–“éš”
            intervalTimer = setInterval(scheduler, lookahead);
        }
    }

    /**
     * æ›´æ–° BPM å€¼ä¸¦å°‡å…¶é™åˆ¶åœ¨åˆç†ç¯„åœã€‚
     */
    window.updateBPM = function(newBPM) {
        const parsedBPM = parseInt(newBPM, 10);
        if (isNaN(parsedBPM)) return;

        let clampedBPM = Math.max(40, Math.min(240, parsedBPM));
        bpm = clampedBPM;
        
        bpmDisplay.textContent = bpm;
        bpmInput.value = bpm;
    }

    /**
     * é€éæŒ‰éˆ•æ”¹è®Š BPMã€‚
     */
    window.changeBPM = function(delta) {
        let newBPM = bpm + delta;
        updateBPM(newBPM);
    }

    /**
     * è™•ç†æ»‘é¼ é»æ“Šæˆ–ç©ºç™½éµæŒ‰ä¸‹äº‹ä»¶ä¾†è¨ˆç®—ç¯€æ‹é€Ÿåº¦ (Tap Tempo)ã€‚
     */
    window.handleTap = function() {
        const now = Date.now();
        let calculatedBPM = null;
        let infoMessage = 'é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹';

        if (tapHistory.length > 0) {
            const lastTap = tapHistory[tapHistory.length - 1];
            const interval = now - lastTap;

            if (interval > TAP_RESET_THRESHOLD) {
                tapHistory = [now]; 
                infoMessage = "åµæ¸¬é–‹å§‹... (å·²é‡ç½®)";
                tapTempoInfo.textContent = infoMessage;
                return;
            }

            tapHistory.push(now);

            if (tapHistory.length > 8) {
                tapHistory.shift();
            }

            if (tapHistory.length >= 2) {
                let totalInterval = 0;
                for (let i = 1; i < tapHistory.length; i++) {
                    totalInterval += tapHistory[i] - tapHistory[i - 1];
                }

                const averageInterval = totalInterval / (tapHistory.length - 1);
                calculatedBPM = Math.round(60000 / averageInterval);

                infoMessage = `æœ€è¿‘ ${tapHistory.length - 1} æ¬¡é–“éš”çš„å¹³å‡ BPMï¼š${calculatedBPM}`;
            }
            
        } else {
            tapHistory.push(now);
            infoMessage = "åµæ¸¬é–‹å§‹... (è«‹é»æ“Šç¬¬äºŒæ¬¡)";
        }

        if (calculatedBPM !== null) {
            const clampedBPM = Math.max(40, Math.min(240, calculatedBPM));
            updateBPM(clampedBPM);
        }
        
        tapTempoInfo.textContent = infoMessage;
    };


    /**
     * æ›´æ–°é¼“æ¨¡å¼åœ–ç¤ºã€‚
     */
    function updateDrumModeIcon() {
        if (isDrumMode) {
            drumIcon.classList.remove('text-gray-400');
            drumIcon.classList.add('text-purple-300');
            drumModeToggle.classList.add('bg-[#6a5acd]');
            drumModeToggle.classList.remove('bg-[#4a4768]');
        } else {
            drumIcon.classList.add('text-gray-400');
            drumIcon.classList.remove('text-purple-300');
            drumModeToggle.classList.remove('bg-[#6a5acd]');
            drumModeToggle.classList.add('bg-[#4a4768]');
        }
    }

    /**
     * åˆ‡æ›é¼“ç¯€å¥æ¨¡å¼ã€‚
     */
    window.toggleDrumMode = function() {
        isDrumMode = !isDrumMode;
        updateDrumModeIcon();
    }
    
    /**
     * æ›´æ–°å…¨è¢å¹•é–å®šåœ–ç¤ºã€‚
     */
    function updateFullscreenLockIcon() {
        // å¦‚æœé–å®š (Disabled=true)ï¼Œå‰‡é¡¯ç¤ºé–‰çœ¼ï¼Œè¡¨ç¤ºã€Œåœç•™åœ¨é€™è£¡ã€
        if (isFullscreenDisabled) {
            // é–‹çœ¼ SVG (Locked - åœç•™åœ¨ä¸»ç•«é¢)
            eyeIcon.innerHTML = `<path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/>`;
            eyeIcon.classList.add('text-purple-300');
            eyeIcon.classList.remove('text-gray-400');
            fullscreenLockToggle.classList.add('bg-[#6a5acd]');
            fullscreenLockToggle.classList.remove('bg-[#4a4768]');
        } else {
            // é–‰çœ¼ SVG (Unlocked - å…è¨±è‡ªå‹•å…¨è¢å¹•)
            eyeIcon.innerHTML = `<path d="m15 18-.722-3.25"/><path d="M2 8a10.645 10.645 0 0 0 20 0"/><path d="m20 15-1.726-2.05"/><path d="m4 15 1.726-2.05"/><path d="m9 18 .722-3.25"/>`;
            eyeIcon.classList.remove('text-purple-300');
            eyeIcon.classList.add('text-gray-400');
            fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
            fullscreenLockToggle.classList.add('bg-[#4a4768]');
        }
    }

    /**
     * åˆ‡æ›å…¨è¢å¹•é–å®šæ¨¡å¼ã€‚
     */
    window.toggleFullscreenLock = function() {
        isFullscreenDisabled = !isFullscreenDisabled;
        updateFullscreenLockIcon();
        if (isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout);
        } else {
            resetAutoFullscreenTimeout();
        }
        hideVisualization(); // åˆ‡æ›ç‹€æ…‹æ™‚ï¼Œå¦‚æœæ­£åœ¨å…¨è¢å¹•ï¼Œå‰‡é€€å‡º
    }

    /**
     * æ›´æ–°ç´°åˆ†æŒ‡ç¤ºç‡ˆä¸Šçš„æ¨™ç±¤ã€‚
     */
    function updateSubdivisionLabels() {
        beatIndicators.forEach((indicator, index) => {
            const mode = beatSubdivisions[index];
            const modeTextSpan = indicator.querySelector('.mode-text');
            
            indicator.classList.remove('bg-gray-900', 'opacity-50');
            indicator.classList.add('bg-gray-600');

            if (modeTextSpan) {
                modeTextSpan.innerHTML = SUBDIVISION_LABELS[mode];
            }
            
            if (mode === 4) { // Mute Mode
                indicator.classList.remove('bg-gray-600');
                indicator.classList.add('bg-gray-900', 'opacity-50');
            }
        });
    }

    /**
     * åˆ‡æ›å–®å€‹ç¯€æ‹çš„ç´°åˆ†æ¨¡å¼ã€‚
     */
    window.toggleSubdivision = function(beatIndex) {
        let currentMode = beatSubdivisions[beatIndex];
        currentMode = (currentMode + 1) % (Object.keys(SUBDIVISION_LABELS).length);
        beatSubdivisions[beatIndex] = currentMode;
        
        updateSubdivisionLabels();
    }
    
    // --- äº‹ä»¶ç›£è½å™¨ ---

    // éµç›¤å¿«æ·éµ
    document.addEventListener('keydown', (e) => {
        if (isVisualizationActive) {
            // åœ¨å…¨è¢å¹•æ¨¡å¼ä¸‹ï¼Œä»»ä½•éµç›¤äº‹ä»¶éƒ½æ‡‰é€€å‡º
            hideVisualization(); 
            return;
        }
        
        if (e.code === 'Space' && document.activeElement !== bpmInput) {
            e.preventDefault(); // é˜²æ­¢æ»¾å‹•
            handleTap();
        } else if (e.key === 'd' || e.key === 'D') {
            toggleDrumMode();
        } else if (e.key === 'f' || e.key === 'F') {
            toggleFullscreenLock();
        }
    });
    
    // æ»‘é¼ ç§»å‹•äº‹ä»¶ï¼Œç”¨æ–¼é‡ç½®è‡ªå‹•å…¨è¢å¹•è¨ˆæ™‚å™¨
    document.addEventListener('mousemove', resetAutoFullscreenTimeout);
    
    // å»¶é²åˆå§‹åŒ–ä»¥ç¢ºä¿ DOM å…ƒç´ éƒ½å·²è¼‰å…¥
    document.addEventListener('DOMContentLoaded', initApp);

</script>
</body>
</html>
