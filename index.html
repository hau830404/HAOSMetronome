<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯€æ‹å™¨ (Metronome)</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®š Inter å­—é«”ï¼Œä»¥åŠæ‡‰ç”¨ç¨‹å¼çš„èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯ */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 40px 20px;
            overflow-y: auto;
            /* ç¦ç”¨æ–‡å­—åç™½é¸å–åŠŸèƒ½ */
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* è‡ªè¨‚æŒ‰éˆ•æ¨£å¼ */
        .metronome-button {
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
        }

        .metronome-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .metronome-button:active {
            opacity: 0.7;
            transform: translateY(1px);
        }

        /* ç¯€æ‹å™¨å¡ç‰‡ */
        .metronome-card {
            background-color: #2c2a4a;
            border: 1px solid #4a4768;
            transition: transform 0.2s;
            max-width: 420px;
            width: 100%;
            overflow-y: auto;
            scrollbar-width: none; 
            -ms-overflow-style: none;  
        }
        .metronome-card::-webkit-scrollbar { 
            display: none; 
        }

        /* æ‡‰ç”¨ç¨‹å¼ä¸»å®¹å™¨ (ç”¨æ–¼æ»‘å‹•) */
        #app-wrapper {
            max-width: 420px;
            width: 100%;
            height: 800px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        /* ç¯€æ‹æŒ‡ç¤ºç‡ˆ */
        .beat-indicator {
            transition: background-color 0.1s;
        }

        /* éš±è—é è¨­çš„ input number ç®­é ­ï¼Œä¸¦å…è¨±æ–‡å­—é¸å– */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            user-select: auto; 
        }
        
        input[type="text"] {
            user-select: auto;
        }

        /* è¦–è¦ºåŒ–è±¡é™çš„åŸºåº•æ¨£å¼ */
        .beat-quadrant {
            background-color: #2c2a4a; /* æš—è‰²èƒŒæ™¯ä½œç‚ºåº•åœ– */
            border: 1px solid #4a4768;
            transition: all 0.15s ease; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è¦–è¦ºåŒ–æ•¸å­—çš„åŸºåº•æ¨£å¼ */
        .visualization-text-container {
            transition: all 0.075s ease-out; 
            will-change: transform, color; 
        }

        /* æ­Œå–®é …ç›® */
        .song-item {
            transition: background-color 0.2s;
        }
        .song-item.active {
            background-color: #5a577d;
            border-left: 4px solid #9a7dff;
        }
    </style>
</head>
<body>

<!-- æ‡‰ç”¨ç¨‹å¼ä¸»å¡ç‰‡å®¹å™¨ (åŒ…å«å¤šé å¡ç‰‡) -->
<div id="app-wrapper" class="overflow-hidden relative shadow-2xl rounded-xl">
    <!-- å·¦å´åˆ‡æ›ç®­é ­ -->
    <button id="prevBtn" onclick="prevCard()" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 p-2 text-white/70 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    </button>
    <!-- å³å´åˆ‡æ›ç®­é ­ -->
    <button id="nextBtn" onclick="nextCard()" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 p-2 text-white/70 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </button>

    <!-- å¡ç‰‡å…§å®¹å®¹å™¨ -->
    <div id="card-container" class="flex transition-transform duration-300 ease-in-out" style="width: 200%;">
        
        <!-- å¡ç‰‡ 1: ç¯€æ‹å™¨ä¸»ç•«é¢ -->
        <div id="card-1" class="metronome-card p-6 md:p-8 rounded-xl shadow-2xl text-center flex-shrink-0 flex flex-col justify-start" style="width: 50%; height: 800px;">
            
            <!-- æ¨™é¡Œ -->
            <h1 class="text-3xl font-extrabold mb-12 text-[#9a7dff] flex-shrink-0 mt-4">
                ğŸµ æ•¸ä½ç¯€æ‹å™¨
            </h1>

            <!-- BPM æ§åˆ¶å€ (æ”¾å¤§ä¸”ç½®ä¸­) -->
            <div class="flex items-center justify-center space-x-6 mb-12 flex-shrink-0">
                <!-- æ¸›å°‘ BPM æŒ‰éˆ• -->
                <button onclick="changeBPM(-1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-4 rounded-full text-3xl font-bold w-16 h-16 flex items-center justify-center">
                    âˆ’
                </button>
                
                <!-- BPM è¼¸å…¥æ¡† (æ”¾å¤§å­—é«”èˆ‡å¯¬åº¦) -->
                <input type="number" id="bpmInput" value="120" min="40" max="240"
                       onchange="updateBPM(this.value)"
                       class="w-48 text-center text-6xl font-bold bg-[#4a4768] p-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#9a7dff] transition-all duration-150 border border-[#6a5acd]">

                <!-- å¢åŠ  BPM æŒ‰éˆ• -->
                <button onclick="changeBPM(1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-4 rounded-full text-3xl font-bold w-16 h-16 flex items-center justify-center">
                    ï¼‹
                </button>
            </div>

            <!-- æŒ‰éˆ•å®¹å™¨: Fullscreen Lock, Start/Stop & Drum Toggle -->
            <div class="flex space-x-3 mb-8 justify-center flex-shrink-0 w-full">
                <!-- é–å®šå…¨è¢å¹•æŒ‰éˆ• -->
                <button id="fullscreenLockToggle" onclick="toggleFullscreenLock()"
                        title="é–å®šè‡ªå‹•å…¨è¢å¹• (F)"
                        class="metronome-button w-1/5 py-5 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
                    <div id="fullscreenIconContainer" class="text-gray-400 transition-colors duration-150 w-8 h-8 flex items-center justify-center">
                        <!-- åˆå§‹åœ–ç¤ºå°‡ç”± JS æ³¨å…¥ -->
                    </div>
                </button>

                <!-- é–‹å§‹/åœæ­¢ æŒ‰éˆ• -->
                <button id="startButton" onclick="startStop()"
                        class="metronome-button w-3/5 py-5 text-2xl font-bold rounded-xl bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-700">
                    é–‹å§‹
                </button>
                <!-- Drum Mode Toggle -->
                <button id="drumModeToggle" onclick="toggleDrumMode()"
                        title="åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)"
                        class="metronome-button w-1/5 py-5 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
                    <svg id="drumIcon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 transition-colors duration-150">
                        <path d="m2 2 8 8"/><path d="m22 2-8 8"/><ellipse cx="12" cy="9" rx="10" ry="5"/><path d="M7 13.4v7.9"/><path d="M12 14v8"/><path d="M17 13.4v7.9"/><path d="M2 9v8a10 5 0 0 0 20 0V9"/>
                    </svg>
                </button>
            </div>

            <!-- æ­Œæ›²åˆ‡æ›æ§åˆ¶åˆ— (åœ¨é–‹å§‹æŒ‰éˆ•ä¸‹æ–¹) -->
            <div class="flex items-center justify-between bg-[#4a4768] rounded-lg p-3 mb-8 shadow-md w-full flex-shrink-0">
                <button onclick="prevSong()" class="text-gray-300 hover:text-white p-2 active:scale-95 transition-transform flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
                <div class="flex flex-col items-center overflow-hidden px-2 flex-grow min-w-0">
                    <span id="currentSongTitle" class="text-white font-bold text-lg truncate w-full text-center">æœªé¸æ“‡æ­Œæ›²</span>
                    <span id="currentSongBPMInfo" class="text-xs text-gray-400">--- BPM</span>
                </div>
                <button onclick="nextSong()" class="text-gray-300 hover:text-white p-2 active:scale-95 transition-transform flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
                </button>
            </div>

            <!-- Tap Tempo & æ‹æ•¸æ§åˆ¶å€ -->
            <div class="flex items-stretch justify-between w-full mb-8 space-x-3 flex-shrink-0">
                <!-- Tap Tempo -->
                <div id="tapTempoArea" 
                     onclick="handleTap()"
                     class="flex-1 p-2 bg-[#4a4768] rounded-xl cursor-pointer hover:bg-[#5a577d] transition-colors border border-dashed border-[#6a5acd] active:scale-[0.99] flex flex-col items-center justify-center min-h-[80px]">
                    <p class="text-base font-semibold text-gray-200 uppercase tracking-wider">
                        TAP
                    </p>
                    <p id="tapTempoInfo" class="text-[10px] text-gray-400 mt-1 text-center leading-tight">
                        åµæ¸¬ç¯€æ‹
                    </p>
                </div>

                <!-- æ‹æ•¸æ§åˆ¶ -->
                <div class="flex-1 p-2 bg-[#252340] rounded-xl border border-[#4a4768] flex flex-col items-center justify-center min-h-[80px]">
                    <div class="text-[10px] text-gray-400 mb-1 uppercase tracking-wider">Beats</div>
                    <div class="flex items-center justify-between w-full px-2">
                        <button onclick="changeBeats(-1)" class="text-white hover:text-[#9a7dff] p-2 active:scale-95 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
                        </button>
                        <span id="beatsDisplay" class="text-[#9a7dff] text-3xl font-bold">4</span>
                        <button onclick="changeBeats(1)" class="text-white hover:text-[#9a7dff] p-2 active:scale-95 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç¯€æ‹æŒ‡ç¤ºç‡ˆ -->
            <div id="beatIndicators" class="flex justify-center flex-wrap gap-4 mt-2 px-2 flex-shrink-0 pb-8">
                <!-- JS å°‡æœƒåœ¨é€™è£¡æ’å…¥æŒ‡ç¤ºç‡ˆ -->
            </div>
        </div>

        <!-- å¡ç‰‡ 2: æ­Œå–®ç®¡ç† (Setlist) -->
        <div id="card-2" class="metronome-card p-6 md:p-10 rounded-xl shadow-2xl text-center flex-shrink-0 flex flex-col justify-start" style="width: 50%; height: 800px;">
            <h2 class="text-3xl font-bold text-[#9a7dff] mb-2 mt-4 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                æ­Œå–®ç®¡ç†
            </h2>
            <p class="text-gray-400 text-sm mb-8">ç·¨è¼¯æ­Œæ›²æ¸…å–®ï¼Œåœ¨ä¸»é é¢å¿«é€Ÿåˆ‡æ›</p>

            <!-- æ–°å¢æ­Œæ›²è¡¨å–® -->
            <div class="bg-[#4a4768] p-5 rounded-xl mb-6 text-left shadow-lg flex-shrink-0">
                <div class="mb-4">
                    <label for="newSongName" class="block text-sm font-medium text-gray-300 mb-1">æ­Œæ›²åç¨±</label>
                    <input type="text" id="newSongName" placeholder="è¼¸å…¥æ­Œå" 
                           class="w-full bg-[#1a1a2e] border border-[#6a5acd] rounded-lg px-3 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#9a7dff]">
                </div>
                <div class="flex space-x-3 items-end">
                    <div class="flex-1">
                        <label for="newSongBpm" class="block text-sm font-medium text-gray-300 mb-1">BPM</label>
                        <input type="number" id="newSongBpm" placeholder="120" 
                               class="w-full bg-[#1a1a2e] border border-[#6a5acd] rounded-lg px-3 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#9a7dff]">
                    </div>
                    <button onclick="addSongToList()" class="bg-[#9a7dff] hover:bg-[#8b6be8] text-white font-bold py-2 px-6 rounded-lg transition-colors h-[50px] flex items-center shadow-md">
                        æ–°å¢
                    </button>
                </div>
            </div>

            <!-- æ­Œå–®åˆ—è¡¨ -->
            <div id="songListContainer" class="flex-grow overflow-y-auto space-y-3 pb-20 text-left px-1">
                <!-- æ­Œæ›²é …ç›®ç”± JS ç”¢ç”Ÿ -->
            </div>
        </div>

    </div>

    <!-- é é¢å°èˆªåœ“é» -->
    <div id="card-dots" class="absolute bottom-6 left-1/2 transform -translate-x-1/2 flex space-x-3 z-10">
        <div data-index="0" class="card-dot w-3 h-3 rounded-full bg-white/40 cursor-pointer" onclick="goToCard(0)"></div>
        <div data-index="1" class="card-dot w-3 h-3 rounded-full bg-white/40 cursor-pointer" onclick="goToCard(1)"></div>
    </div>
</div>

<!-- è¦–è¦ºåŒ–å…¨è¢å¹•æ¨¡å¼ -->
<div id="visualizationScreen" 
     class="hidden fixed inset-0 z-50 p-4 sm:p-8 bg-gray-900/95 cursor-pointer grid gap-4 sm:gap-8"
     title="é»æ“Šä»»æ„è™•é€€å‡ºè¦–è¦ºåŒ–æ¨¡å¼">
     <!-- JS å°‡æœƒåœ¨é€™è£¡æ’å…¥ç¶²æ ¼ -->
</div>

<script type="module">
    // Web Audio API
    let audioContext;
    let isPlaying = false;
    let lookahead = 25.0; 
    let scheduleAheadTime = 0.1; 
    let nextNoteTime = 0.0; 

    // State
    let bpm = 120;
    let beatsPerMeasure = 4; 
    let currentBeat = 0; 
    let isDrumMode = false; 
    let isVisualizationMode = false; 
    let isFullscreenDisabled = false; 
    let beatSubdivisions = new Array(beatsPerMeasure).fill(0); 
    
    // Song List State
    let songList = []; 
    let currentSongIndex = -1;

    // UI Constants
    const SUBDIVISION_LABELS = {
        0: `<span class="text-lg font-extrabold relative top-[-1px]">1</span>`, 
        1: `<span class="text-lg font-extrabold relative top-[-1px]">2</span>`, 
        2: `<span class="text-lg font-extrabold relative top-[-1px]">4</span>`, 
        3: `<span class="text-lg font-extrabold relative top-[-1px]">3</span>`, 
        4: `<span class="text-xl font-extrabold text-red-500">M</span>`, 
    };
    
    const DRUM_KICK_FREQ = 80.0;     
    const DRUM_SNARE_FREQ = 200.0;   
    const DRUM_SNARE_DURATION = 0.1; 
    const METRONOME_STRONG_FREQ = 600.0;
    const METRONROME_WEAK_FREQ = 400.0;
    const METRONOME_DURATION = 0.05; 
    const METRONOME_SUB_FREQ = 350.0; 
    const SUBDIVISION_VOLUME_MULTIPLIER = 0.8; 

    const SVG_EYE_CLOSED = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="m15 18-.722-3.25"/><path d="M2 8a10.645 10.645 0 0 0 20 0"/><path d="m20 15-1.726-2.05"/><path d="m4 15 1.726-2.05"/><path d="m9 18 .722-3.25"/></svg>`;
    const SVG_EYE_OPEN = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>`;

    // DOM Elements
    const appWrapper = document.getElementById('app-wrapper');
    const cardContainer = document.getElementById('card-container');
    const cardDots = document.querySelectorAll('.card-dot');
    const numCards = cardDots.length;
    let currentCardIndex = 0;
    
    const visualizationScreen = document.getElementById('visualizationScreen');
    const startButton = document.getElementById('startButton');
    const bpmInput = document.getElementById('bpmInput');
    const beatIndicatorsContainer = document.getElementById('beatIndicators');
    const beatsDisplay = document.getElementById('beatsDisplay');
    const tapTempoInfo = document.getElementById('tapTempoInfo');
    const drumModeToggle = document.getElementById('drumModeToggle'); 
    const drumIcon = document.getElementById('drumIcon');
    const fullscreenLockToggle = document.getElementById('fullscreenLockToggle'); 
    const fullscreenIconContainer = document.getElementById('fullscreenIconContainer'); 
    
    // Song List DOM
    const newSongNameInput = document.getElementById('newSongName');
    const newSongBpmInput = document.getElementById('newSongBpm');
    const songListContainer = document.getElementById('songListContainer');
    const currentSongTitle = document.getElementById('currentSongTitle');
    const currentSongBPMInfo = document.getElementById('currentSongBPMInfo');

    let intervalTimer = null;
    let tapHistory = [];
    const TAP_RESET_THRESHOLD = 2000; 
    let autoFullscreenTimeout = null;
    const AUTO_FULLSCREEN_DELAY = 3000; 

    // ------------------------------------------
    // --- æ­Œå–®ç®¡ç† (Song List Logic) ---
    // ------------------------------------------
    
    function loadSongs() {
        const stored = localStorage.getItem('metronome_songs');
        if (stored) {
            try {
                songList = JSON.parse(stored);
            } catch (e) {
                songList = [];
            }
        }
        renderSongList();
    }

    function saveSongs() {
        localStorage.setItem('metronome_songs', JSON.stringify(songList));
        renderSongList();
    }

    window.addSongToList = function() {
        const name = newSongNameInput.value.trim();
        const bpmVal = parseInt(newSongBpmInput.value);

        if (!name) {
            alert('è«‹è¼¸å…¥æ­Œæ›²åç¨±');
            return;
        }
        if (!bpmVal || bpmVal < 40 || bpmVal > 240) {
            alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ BPM (40-240)');
            return;
        }

        songList.push({
            id: Date.now().toString(),
            name: name,
            bpm: bpmVal
        });

        newSongNameInput.value = '';
        newSongBpmInput.value = '';
        saveSongs();
    }

    window.deleteSong = function(id) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™é¦–æ­Œå—ï¼Ÿ')) {
            songList = songList.filter(s => s.id !== id);
            if (currentSongIndex >= 0 && currentSongIndex < songList.length) {
                 // Keep index
            } else {
                currentSongIndex = -1;
                updateSongDisplay();
            }
            saveSongs();
        }
    }

    window.selectSong = function(index) {
        if (index >= 0 && index < songList.length) {
            currentSongIndex = index;
            const song = songList[index];
            updateBPM(song.bpm);
            updateSongDisplay();
            
            goToCard(0); 
        }
    }

    window.prevSong = function() {
        if (songList.length === 0) return;
        
        if (currentSongIndex === -1) {
            currentSongIndex = songList.length - 1;
        } else {
            currentSongIndex--;
            if (currentSongIndex < 0) currentSongIndex = songList.length - 1; 
        }
        
        const song = songList[currentSongIndex];
        updateBPM(song.bpm);
        updateSongDisplay();
    }

    window.nextSong = function() {
        if (songList.length === 0) return;
        
        if (currentSongIndex === -1) {
            currentSongIndex = 0;
        } else {
            currentSongIndex++;
            if (currentSongIndex >= songList.length) currentSongIndex = 0; 
        }
        
        const song = songList[currentSongIndex];
        updateBPM(song.bpm);
        updateSongDisplay();
    }

    function updateSongDisplay() {
        if (currentSongIndex >= 0 && currentSongIndex < songList.length) {
            const song = songList[currentSongIndex];
            currentSongTitle.textContent = song.name;
            currentSongBPMInfo.textContent = `${song.bpm} BPM`;
        } else {
            currentSongTitle.textContent = 'æœªé¸æ“‡æ­Œæ›²';
            currentSongBPMInfo.textContent = '--- BPM';
        }
        renderSongList();
    }

    function renderSongList() {
        songListContainer.innerHTML = '';
        if (songList.length === 0) {
            songListContainer.innerHTML = '<div class="text-gray-500 text-center mt-4">å°šç„¡æ­Œæ›²</div>';
            return;
        }

        songList.forEach((song, index) => {
            const el = document.createElement('div');
            const isActive = index === currentSongIndex;
            const activeClass = isActive ? 'bg-[#5a577d] border-l-4 border-[#9a7dff]' : 'bg-[#4a4768] hover:bg-[#5a577d]';
            
            el.className = `song-item ${activeClass} p-4 rounded-lg flex justify-between items-center cursor-pointer mb-3 shadow-sm`;
            el.innerHTML = `
                <div class="flex flex-col flex-grow pr-4" onclick="selectSong(${index})">
                    <span class="font-bold text-white text-lg">${song.name}</span>
                    <span class="text-sm text-[#9a7dff] font-mono mt-1">${song.bpm} BPM</span>
                </div>
                <button onclick="deleteSong('${song.id}')" class="text-gray-400 hover:text-red-400 p-2 rounded-full hover:bg-[#36334d] transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                </button>
            `;
            songListContainer.appendChild(el);
        });
    }

    // ------------------------------------------
    // --- æ»‘å‹•/å°èˆªé‚è¼¯ ---
    // ------------------------------------------
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    const sensitivity = 50; 

    function setCardPosition(index) {
        currentCardIndex = Math.max(0, Math.min(index, numCards - 1));
        currentTranslate = currentCardIndex * (-100 / numCards); 
        cardContainer.style.transform = `translateX(${currentTranslate}%)`;
        
        cardDots.forEach((dot, i) => {
            dot.classList.remove('bg-white');
            dot.classList.add('bg-white/40');
            if (i === currentCardIndex) {
                dot.classList.add('bg-white');
            }
        });
        document.getElementById('prevBtn').style.display = currentCardIndex === 0 ? 'none' : 'block';
        document.getElementById('nextBtn').style.display = currentCardIndex === numCards - 1 ? 'none' : 'block';
    }

    window.goToCard = function(index) {
        cardContainer.style.transition = 'transform 0.3s ease-in-out';
        setCardPosition(index);
        setTimeout(() => { cardContainer.style.transition = 'none'; }, 300);
    }
    window.nextCard = function() { window.goToCard(currentCardIndex + 1); }
    window.prevCard = function() { window.goToCard(currentCardIndex - 1); }

    function getPositionX(event) {
        return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
    }
    function touchStart(event) {
        if (event.target.closest('#songListContainer') || event.target.tagName === 'INPUT') return;
        isDragging = true;
        startX = getPositionX(event);
        prevTranslate = currentTranslate;
        cardContainer.style.transition = 'none'; 
    }
    function touchMove(event) {
        if (!isDragging) return;
        const currentX = getPositionX(event);
        const diff = currentX - startX;
        const translateAmount = (diff / appWrapper.offsetWidth) * (100 / numCards);
        currentTranslate = prevTranslate + translateAmount;
        const maxTranslate = 0;
        const minTranslate = (numCards - 1) * (-100 / numCards);
        currentTranslate = Math.max(minTranslate, Math.min(maxTranslate, currentTranslate));
        cardContainer.style.transform = `translateX(${currentTranslate}%)`;
    }
    function touchEnd() {
        if (!isDragging) return;
        isDragging = false;
        const movedBy = currentTranslate - prevTranslate;
        let targetIndex = currentCardIndex;
        if (movedBy < -sensitivity) { targetIndex += 1; } 
        else if (movedBy > sensitivity) { targetIndex -= 1; }
        cardContainer.style.transition = 'transform 0.3s ease-in-out';
        setCardPosition(targetIndex);
    }

    appWrapper.addEventListener('touchstart', touchStart, { passive: true });
    appWrapper.addEventListener('touchend', touchEnd);
    appWrapper.addEventListener('touchmove', touchMove, { passive: true });
    appWrapper.addEventListener('mousedown', touchStart);
    appWrapper.addEventListener('mouseup', touchEnd);
    appWrapper.addEventListener('mouseleave', () => { if (isDragging) touchEnd(); });
    appWrapper.addEventListener('mousemove', touchMove);

    // ------------------------------------------
    // --- æ‹æ•¸æ§åˆ¶é‚è¼¯ ---
    // ------------------------------------------
    
    window.changeBeats = function(delta) {
        let newBeats = beatsPerMeasure + delta;
        newBeats = Math.max(1, Math.min(12, newBeats));
        
        if (newBeats !== beatsPerMeasure) {
            beatsPerMeasure = newBeats;
            if (newBeats > beatSubdivisions.length) {
                const diff = newBeats - beatSubdivisions.length;
                for (let i = 0; i < diff; i++) {
                    beatSubdivisions.push(0);
                }
            } else {
                beatSubdivisions.length = newBeats;
            }
            renderUI();
        }
    }

    function renderUI() {
        beatsDisplay.textContent = beatsPerMeasure;
        beatIndicatorsContainer.innerHTML = '';
        for (let i = 1; i <= beatsPerMeasure; i++) {
            const indicator = document.createElement('div');
            indicator.className = `beat-indicator w-14 h-14 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer transform scale-100 flex-shrink-0 transition-all duration-100`;
            indicator.dataset.beat = i;
            indicator.onclick = () => window.toggleSubdivision(i - 1);
            const mode = beatSubdivisions[i-1];
            const span = document.createElement('span');
            span.className = 'absolute font-bold text-white mode-text text-xl pointer-events-none'; 
            span.innerHTML = SUBDIVISION_LABELS[mode];
            indicator.appendChild(span);
            beatIndicatorsContainer.appendChild(indicator);
        }
        updateSubdivisionLabels();
        visualizationScreen.innerHTML = '';
        let cols = Math.ceil(Math.sqrt(beatsPerMeasure));
        if (beatsPerMeasure === 2) cols = 2; 
        visualizationScreen.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        for (let i = 1; i <= beatsPerMeasure; i++) {
            const quadrant = document.createElement('div');
            quadrant.className = 'beat-quadrant flex items-center justify-center rounded-xl transition-colors duration-150';
            quadrant.id = `visual_${i}`;
            quadrant.dataset.beat = i;
            const textContainer = document.createElement('div');
            textContainer.className = 'visualization-text-container text-[100px] sm:text-[200px] font-extrabold transition-all duration-75';
            if (beatsPerMeasure > 4) textContainer.classList.replace('text-[100px]', 'text-[60px]');
            if (beatsPerMeasure > 4) textContainer.classList.replace('sm:text-[200px]', 'sm:text-[120px]');
            const span = document.createElement('span');
            span.className = 'beat-number-main text-gray-700 transition-all duration-75 transform scale-100';
            span.textContent = i;
            textContainer.appendChild(span);
            quadrant.appendChild(textContainer);
            visualizationScreen.appendChild(quadrant);
        }
    }

    // ------------------------------------------
    // --- ç¯€æ‹å™¨æ ¸å¿ƒé‚è¼¯ ---
    // ------------------------------------------

    function initializeAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playClick(time, pitch, duration, volume = 1.0) {
        if (!audioContext) return;
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine'; 
        oscillator.frequency.setValueAtTime(pitch, time); 
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(volume, time); 
        gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start(time);
        oscillator.stop(time + duration);
    }

    function scheduler() {
        while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
            const secondsPerBeat = 60.0 / bpm;
            currentBeat = (currentBeat % beatsPerMeasure) + 1;
            const beatIndex = currentBeat - 1; 
            const subdivisionMode = beatSubdivisions[beatIndex]; 

            let subdivisionCount = 1; 
            if (subdivisionMode === 1) subdivisionCount = 2;
            else if (subdivisionMode === 2) subdivisionCount = 4;
            else if (subdivisionMode === 3) subdivisionCount = 3;
            else if (subdivisionMode === 4) subdivisionCount = 0;

            if (subdivisionCount >= 0) {
                const subDuration = (subdivisionCount > 0) ? secondsPerBeat / subdivisionCount : secondsPerBeat;
                const actualSubCount = subdivisionCount > 0 ? subdivisionCount : 1; 

                for (let i = 0; i < actualSubCount; i++) {
                    const clickTime = nextNoteTime + i * subDuration;
                    const subStep = (subdivisionCount === 0) ? -1 : i; 
                    updateVisuals(currentBeat, subStep, subdivisionMode);
                    
                    if (subdivisionCount === 0) continue; 
                    
                    let pitch;
                    let duration;
                    let volumeMultiplier; 
                    const isMainBeatClick = (i === 0);

                    if (isMainBeatClick) {
                        volumeMultiplier = 1.0; 
                    } else {
                        volumeMultiplier = SUBDIVISION_VOLUME_MULTIPLIER;
                    }

                    if (isDrumMode) {
                        if (isMainBeatClick) {
                            pitch = (currentBeat === 1 || currentBeat === 3) ? DRUM_KICK_FREQ : DRUM_SNARE_FREQ;
                            duration = (currentBeat === 2 || currentBeat === 4) ? DRUM_SNARE_DURATION : METRONOME_DURATION;
                        } else {
                            pitch = 800.0; 
                            duration = METRONOME_DURATION * 0.3;
                        }
                    } else {
                        duration = METRONOME_DURATION; 
                        if (currentBeat === 1 && isMainBeatClick) {
                            pitch = METRONOME_STRONG_FREQ; 
                        } else if (isMainBeatClick) {
                            pitch = METRONROME_WEAK_FREQ; 
                        } else {
                            pitch = METRONOME_SUB_FREQ; 
                        }
                    }
                    playClick(clickTime, pitch, duration, volumeMultiplier);
                }
            } 
            nextNoteTime += secondsPerBeat;
        }
    }

    function updateVisuals(beat, subdivisionStep, subdivisionMode) {
        const delay = (nextNoteTime - audioContext.currentTime) * 1000;
        setTimeout(() => {
            const animationDuration = 75; 
            
            const indicator = document.querySelector(`.beat-indicator[data-beat="${beat}"]`);
            
            beatIndicatorsContainer.querySelectorAll('.beat-indicator').forEach((ind, index) => {
                ind.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'scale-110');
                if (beatSubdivisions[index] !== 4) { 
                    ind.classList.remove('bg-gray-900', 'opacity-50');
                    ind.classList.add('bg-gray-600');
                } else {
                     ind.classList.remove('bg-gray-600');
                     ind.classList.add('bg-gray-900', 'opacity-50');
                }
            });
            
            if (indicator && subdivisionStep === 0) { 
                const colorClass = (beat === 1) ? 'bg-[#ff5733]' : 'bg-[#ffc300]';
                if (subdivisionMode !== 4) { 
                    indicator.classList.remove('bg-gray-600');
                    indicator.classList.add(colorClass, 'scale-110'); 
                }
            }
            
            if (isVisualizationMode) {
                const allQuadrants = document.querySelectorAll('.beat-quadrant');
                const isMainFlash = subdivisionStep === 0 || subdivisionStep === -1; 
                
                if (isMainFlash) { 
                    document.querySelectorAll('.beat-number-main').forEach(textEl => {
                        textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
                        textEl.classList.add('text-gray-700');
                    });
                    allQuadrants.forEach(quadrant => {
                        quadrant.classList.remove('bg-[#4a4768]'); 
                    });
                    
                    const currentElement = document.getElementById(`visual_${beat}`);
                    if (currentElement) {
                        const numberColor = (beat === 1) ? 'text-red-400' : 'text-[#9a7dff]';
                        const mainNumber = currentElement.querySelector('.beat-number-main');
                        currentElement.classList.add('bg-[#4a4768]'); 
                        if (mainNumber) {
                            mainNumber.classList.remove('text-gray-700');
                            mainNumber.classList.add('text-white', numberColor, 'scale-105');
                            setTimeout(() => {
                                mainNumber.classList.remove('scale-105'); 
                            }, animationDuration); 
                        }
                    }
                }
            }
        }, delay > 0 ? delay : 0);
    }

    function showVisualization() {
        if (!isPlaying || isFullscreenDisabled) return; 
        clearTimeout(autoFullscreenTimeout); 
        isVisualizationMode = true;
        appWrapper.classList.add('hidden'); 
        visualizationScreen.classList.remove('hidden');
        document.querySelectorAll('.beat-number-main').forEach(textEl => {
            textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
            textEl.classList.add('text-gray-700');
        });
        document.querySelectorAll('.beat-quadrant').forEach(quadrant => {
            quadrant.classList.remove('bg-[#4a4768]');
        });
    }

    window.hideVisualization = function() {
        isVisualizationMode = false;
        visualizationScreen.classList.add('hidden');
        appWrapper.classList.remove('hidden'); 
        document.querySelectorAll('.beat-number-main').forEach(textEl => {
            textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
            textEl.classList.add('text-gray-700');
        });
        document.querySelectorAll('.beat-quadrant').forEach(quadrant => {
            quadrant.classList.remove('bg-[#4a4768]');
        });
        if (isPlaying && !isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout); 
            autoFullscreenTimeout = setTimeout(() => {
                showVisualization();
            }, AUTO_FULLSCREEN_DELAY); 
        }
    }

    window.toggleFullscreenLock = function() {
        isFullscreenDisabled = !isFullscreenDisabled;
        if (isFullscreenDisabled) {
            fullscreenIconContainer.innerHTML = SVG_EYE_CLOSED; 
            fullscreenIconContainer.classList.remove('text-gray-400'); 
            fullscreenIconContainer.classList.add('text-[#9a7dff]'); 
            fullscreenLockToggle.classList.remove('bg-[#4a4768]');
            fullscreenLockToggle.classList.add('bg-[#6a5acd]'); 
            fullscreenLockToggle.title = 'è§£é–è‡ªå‹•å…¨è¢å¹• (F)';
            clearTimeout(autoFullscreenTimeout); 
            if (isVisualizationMode) hideVisualization();
        } else {
            fullscreenIconContainer.innerHTML = SVG_EYE_OPEN; 
            fullscreenIconContainer.classList.remove('text-[#9a7dff]'); 
            fullscreenIconContainer.classList.add('text-gray-400'); 
            fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
            fullscreenLockToggle.classList.add('bg-[#4a4768]');
            fullscreenLockToggle.title = 'é–å®šè‡ªå‹•å…¨è¢å¹• (F)';
            if (isPlaying) hideVisualization(); 
        }
    }

    visualizationScreen.addEventListener('click', () => { hideVisualization(); });

    window.startStop = function() {
        initializeAudio();
        if (isPlaying) {
            clearInterval(intervalTimer);
            isPlaying = false;
            hideVisualization(); 
            clearTimeout(autoFullscreenTimeout); 
            startButton.textContent = 'é–‹å§‹';
            startButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');
            startButton.classList.add('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            
            beatIndicatorsContainer.querySelectorAll('.beat-indicator').forEach((ind, index) => {
                ind.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'scale-110');
                if (beatSubdivisions[index] !== 4) {
                    ind.classList.add('bg-gray-600');
                    ind.classList.remove('bg-gray-900', 'opacity-50');
                } else {
                     ind.classList.add('bg-gray-900', 'opacity-50');
                     ind.classList.remove('bg-gray-600');
                }
            });
            currentBeat = 0;
        } else {
            if (audioContext.state === 'suspended') { audioContext.resume(); }
            isPlaying = true;
            startButton.textContent = 'åœæ­¢';
            startButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            startButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');
            currentBeat = 0;
            nextNoteTime = audioContext.currentTime;
            if (!isFullscreenDisabled) { setTimeout(showVisualization, 1000); }
            intervalTimer = setInterval(scheduler, lookahead);
        }
    }

    window.updateBPM = function(newBPM) {
        const parsedBPM = parseInt(newBPM, 10);
        if (isNaN(parsedBPM)) return;
        let clampedBPM = Math.max(40, Math.min(240, parsedBPM));
        bpm = clampedBPM;
        bpmInput.value = bpm;
    }

    window.changeBPM = function(delta) {
        let newBPM = bpm + delta;
        updateBPM(newBPM);
    }

    window.handleTap = function() {
        const now = Date.now();
        let calculatedBPM = null;
        let infoMessage = 'é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹';
        if (tapHistory.length > 0) {
            const lastTap = tapHistory[tapHistory.length - 1];
            const interval = now - lastTap;
            if (interval > TAP_RESET_THRESHOLD) {
                tapHistory = [now]; 
                infoMessage = "åµæ¸¬é–‹å§‹... (å·²é‡ç½®)";
                tapTempoInfo.textContent = infoMessage;
                return;
            }
            tapHistory.push(now);
            if (tapHistory.length > 8) { tapHistory.shift(); }
            if (tapHistory.length >= 2) {
                let totalInterval = 0;
                for (let i = 1; i < tapHistory.length; i++) {
                    totalInterval += tapHistory[i] - tapHistory[i - 1];
                }
                const averageInterval = totalInterval / (tapHistory.length - 1);
                calculatedBPM = Math.round(60000 / averageInterval);
                infoMessage = `æœ€è¿‘ ${tapHistory.length - 1} æ¬¡é–“éš”çš„å¹³å‡ BPMï¼š${calculatedBPM}`;
            }
        } else {
            tapHistory.push(now);
            infoMessage = "åµæ¸¬é–‹å§‹... (è«‹é»æ“Šç¬¬äºŒæ¬¡)";
        }
        if (calculatedBPM !== null) {
            const clampedBPM = Math.max(40, Math.min(240, calculatedBPM));
            updateBPM(clampedBPM);
        }
        tapTempoInfo.textContent = infoMessage;
    };

    window.toggleDrumMode = function() {
        isDrumMode = !isDrumMode;
        if (isDrumMode) {
            drumIcon.classList.remove('text-gray-400');
            drumIcon.classList.add('text-[#ffc300]'); 
            drumModeToggle.classList.remove('bg-[#4a4768]');
            drumModeToggle.classList.add('bg-[#6a5acd]'); 
            drumModeToggle.title = 'åˆ‡æ›è‡³ç¯€æ‹å™¨æ¨¡å¼ (D)';
        } else {
            drumIcon.classList.remove('text-[#ffc300]');
            drumIcon.classList.add('text-gray-400');
            drumModeToggle.classList.remove('bg-[#6a5acd]');
            drumModeToggle.classList.add('bg-[#4a4768]');
            drumModeToggle.title = 'åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)';
        }
        if (isPlaying) { window.startStop(); window.startStop(); }
    }

    function updateSubdivisionLabels() {
        const indicators = document.querySelectorAll('.beat-indicator');
        indicators.forEach((indicator, index) => {
            if (index >= beatSubdivisions.length) return; 
            const mode = beatSubdivisions[index];
            const modeTextSpan = indicator.querySelector('.mode-text');
            indicator.classList.remove('bg-gray-900', 'opacity-50');
            indicator.classList.add('bg-gray-600');
            if (modeTextSpan) modeTextSpan.innerHTML = SUBDIVISION_LABELS[mode];
            if (mode === 4) {
                indicator.classList.remove('bg-gray-600');
                indicator.classList.add('bg-gray-900', 'opacity-50');
            }
        });
    }

    window.toggleSubdivision = function(beatIndex) {
        initializeAudio(); 
        let currentMode = beatSubdivisions[beatIndex];
        let newMode = (currentMode + 1) % 5; 
        beatSubdivisions[beatIndex] = newMode;
        updateSubdivisionLabels();
        if (isPlaying) { window.startStop(); window.startStop(); }
    };

    appWrapper.addEventListener('mousemove', () => {
        if (isPlaying && !isVisualizationMode && !isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout);
            autoFullscreenTimeout = setTimeout(() => {
                showVisualization();
            }, AUTO_FULLSCREEN_DELAY);
        }
    });

    document.addEventListener('keydown', (event) => {
        const isInput = event.target.tagName === 'INPUT';
        if (isInput && event.code !== 'Enter') return;
        
        if (isVisualizationMode && event.code !== 'Space' && event.code !== 'KeyD' && event.code !== 'KeyF' && event.code !== 'Enter') {
            event.preventDefault();
            hideVisualization();
            return;
        }

        if (event.code === 'Space') {
            event.preventDefault(); 
            handleTap();
        } else if (event.code === 'KeyD') {
            event.preventDefault(); 
            toggleDrumMode();
        } else if (event.code === 'KeyF') {
            event.preventDefault(); 
            toggleFullscreenLock();
        } else if (event.code === 'Enter') { 
            // å¦‚æœåœ¨æ­Œå–®è¼¸å…¥æ¡†æŒ‰ Enterï¼Œæ–°å¢æ­Œæ›²
            if (isInput && (event.target.id === 'newSongName' || event.target.id === 'newSongBpm')) {
                event.preventDefault();
                addSongToList();
                return;
            }
            
            // ä¸»ç•«é¢æˆ– BPM è¼¸å…¥æ¡†æŒ‰ Enterï¼Œåˆ‡æ›é–‹å§‹/åœæ­¢
            event.preventDefault();
            startStop();
            if (isInput) {
                event.target.blur();
            }
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        updateBPM(bpm);
        drumModeToggle.title = 'åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)';
        isFullscreenDisabled = false;
        fullscreenIconContainer.innerHTML = SVG_EYE_OPEN; 
        fullscreenIconContainer.classList.remove('text-[#9a7dff]'); 
        fullscreenIconContainer.classList.add('text-gray-400'); 
        fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
        fullscreenLockToggle.classList.add('bg-[#4a4768]');
        fullscreenLockToggle.title = 'é–å®šè‡ªå‹•å…¨è¢å¹• (F)';
        
        renderUI();
        setCardPosition(0);
        loadSongs(); // è¼‰å…¥æ­Œå–®
    });
</script>

</body>
</html>
