<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯€æ‹å™¨ (Metronome)</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®š Inter å­—é«”ï¼Œä»¥åŠæ‡‰ç”¨ç¨‹å¼çš„èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯ */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            /* ç¦ç”¨æ–‡å­—åç™½é¸å–åŠŸèƒ½ */
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* è‡ªè¨‚æŒ‰éˆ•æ¨£å¼ */
        .metronome-button {
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
        }

        .metronome-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .metronome-button:active {
            opacity: 0.7;
            transform: translateY(1px);
        }

        /* ç¯€æ‹å™¨å¡ç‰‡ */
        .metronome-card {
            background-color: #2c2a4a;
            border: 1px solid #4a4768;
            transition: transform 0.2s;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´å¡ç‰‡å¯¬åº¦ */
        .metronome-card {
            max-width: 420px;
            width: 100%;
        }

        /* ç•¶å‰ç¯€æ‹è¦–è¦ºæŒ‡ç¤ºç‡ˆ */
        .beat-indicator {
            transition: background-color 0.1s;
        }

        /* éš±è—é è¨­çš„ input number ç®­é ­ï¼Œä¸¦å…è¨±æ–‡å­—é¸å– */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            user-select: auto; /* å…è¨±åœ¨è¼¸å…¥æ¡†å…§é¸å–æ–‡å­— */
        }

        /* è¦–è¦ºåŒ–è±¡é™çš„åŸºåº•æ¨£å¼ */
        .beat-quadrant {
            background-color: #2c2a4a; /* æš—è‰²èƒŒæ™¯ä½œç‚ºåº•åœ– */
            border: 1px solid #4a4768;
            transition: all 0.15s ease; /* è®“èƒŒæ™¯è®ŠåŒ–æ›´æµæš¢ */
        }
        
        /* è¦–è¦ºåŒ–æ•¸å­—çš„åŸºåº•æ¨£å¼ */
        .visualization-text-container {
            /* é…åˆ JS ä¸­çš„ animationDuration */
            transition: all 0.075s ease-out; 
            will-change: transform, color; /* å¹«åŠ© GPU åŠ é€Ÿå‹•ç•« */
        }
    </style>
</head>
<body>

<!-- 1. ç¯€æ‹å™¨ä¸»ç•«é¢ (App Container) -->
<div id="app" class="metronome-card p-6 md:p-8 rounded-xl shadow-2xl text-center">
    <!-- æ¨™é¡Œ -->
    <h1 class="text-3xl font-extrabold mb-6 text-[#9a7dff]">
        ğŸµ æ•¸ä½ç¯€æ‹å™¨
    </h1>

    <!-- ç¯€æ‹é¡¯ç¤ºå€ -->
    <div class="mb-8">
        <span id="bpmDisplay" class="text-7xl font-mono font-bold text-white transition-colors duration-200">
            120
        </span>
        <div class="text-lg text-gray-400 mt-1">
            BPM
        </div>
    </div>

    <!-- BPM æ§åˆ¶å€ -->
    <div class="flex items-center justify-center space-x-4 mb-8">
        <!-- æ¸›å°‘ BPM æŒ‰éˆ• -->
        <button onclick="changeBPM(-1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-3 rounded-full text-2xl font-bold w-12 h-12 flex items-center justify-center">
            âˆ’
        </button>
        
        <!-- BPM è¼¸å…¥æ¡† -->
        <input type="number" id="bpmInput" value="120" min="40" max="240"
               onchange="updateBPM(this.value)"
               class="w-24 text-center text-3xl font-bold bg-[#4a4768] p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#9a7dff] transition-all duration-150 border border-[#6a5acd]">

        <!-- å¢åŠ  BPM æŒ‰éˆ• -->
        <button onclick="changeBPM(1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-3 rounded-full text-2xl font-bold w-12 h-12 flex items-center justify-center">
            ï¼‹
        </button>
    </div>

    <!-- æŒ‰éˆ•å®¹å™¨: Start/Stop & Drum Toggle & Fullscreen Lock -->
    <div class="flex space-x-2 md:space-x-4 mb-6">
        <!-- é–å®šå…¨è¢å¹•æŒ‰éˆ• (Eye Closed / Eye Open) -->
        <button id="fullscreenLockToggle" onclick="toggleFullscreenLock()"
                title="é–å®šè‡ªå‹•å…¨è¢å¹• (F)"
                class="metronome-button w-1/5 py-4 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
            <!-- SVG Icon Container (æœƒå‹•æ…‹æ³¨å…¥ SVG) -->
            <div id="fullscreenIconContainer" class="text-gray-400 transition-colors duration-150 w-7 h-7 flex items-center justify-center">
                <!-- åˆå§‹åœ–ç¤ºå°‡ç”± JS æ³¨å…¥ -->
            </div>
        </button>

        <!-- é–‹å§‹/åœæ­¢ æŒ‰éˆ• (èª¿æ•´ç‚º w-3/5) -->
        <button id="startButton" onclick="startStop()"
                class="metronome-button w-3/5 py-4 text-xl font-bold rounded-xl bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-700">
            é–‹å§‹
        </button>
        <!-- Drum Mode Toggle (èª¿æ•´ç‚º w-1/5) -->
        <button id="drumModeToggle" onclick="toggleDrumMode()"
                title="åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)"
                class="metronome-button w-1/5 py-4 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
            <!-- ä½¿ç”¨è€…æä¾›çš„ Lucide Drum åœ–ç¤º -->
            <svg id="drumIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 transition-colors duration-150">
                <path d="m2 2 8 8"/>
                <path d="m22 2-8 8"/>
                <ellipse cx="12" cy="9" rx="10" ry="5"/>
                <path d="M7 13.4v7.9"/>
                <path d="M12 14v8"/>
                <path d="M17 13.4v7.9"/>
                <path d="M2 9v8a10 5 0 0 0 20 0V9"/>
            </svg>
        </button>
    </div>

    <!-- Tap Tempo å€åŸŸ -->
    <div id="tapTempoArea" 
         onclick="handleTap()"
         class="p-3 bg-[#4a4768] rounded-xl cursor-pointer hover:bg-[#5a577d] transition-colors mb-6 border border-dashed border-[#6a5acd] active:scale-[0.99]">
        <p class="text-base font-semibold text-gray-200 uppercase tracking-wider">
            TAP TEMPO
        </p>
        <p id="tapTempoInfo" class="text-xs text-gray-400 mt-1 h-3">
            é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹
        </p>
    </div>
    
    <!-- ç¯€æ‹æŒ‡ç¤ºç‡ˆ (4/4 æ‹) -->
    <div id="beatIndicators" class="flex justify-around mt-6">
        <div data-beat="1" data-index="0" onclick="toggleSubdivision(0)" class="beat-indicator w-10 h-10 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer">
            <span class="absolute font-bold text-white mode-text">1</span>
        </div>
        <div data-beat="2" data-index="1" onclick="toggleSubdivision(1)" class="beat-indicator w-10 h-10 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer">
            <span class="absolute font-bold text-white mode-text">1</span>
        </div>
        <div data-beat="3" data-index="2" onclick="toggleSubdivision(2)" class="beat-indicator w-10 h-10 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer">
            <span class="absolute font-bold text-white mode-text">1</span>
        </div>
        <div data-beat="4" data-index="3" onclick="toggleSubdivision(3)" class="beat-indicator w-10 h-10 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer">
            <span class="absolute font-bold text-white mode-text">1</span>
        </div>
    </div>
</div>

<!-- 2. è¦–è¦ºåŒ–å…¨è¢å¹•æ¨¡å¼ (åªé¡¯ç¤º 1-4 ç¯€æ‹ï¼Œæ¯æ‹å›ºå®šé–ƒçˆä¸€æ¬¡) -->
<div id="visualizationScreen" 
     class="hidden fixed inset-0 z-50 p-4 sm:p-8 bg-gray-900/95 cursor-pointer grid grid-cols-2 grid-rows-2 gap-4 sm:gap-8"
     title="é»æ“Šä»»æ„è™•é€€å‡ºè¦–è¦ºåŒ–æ¨¡å¼">
    
    <!-- Quadrant 1: å·¦ä¸Š (Beat 1) -->
    <div data-beat="1" id="visual_1" class="beat-quadrant flex items-center justify-center rounded-xl transition-colors duration-150">
        <div class="visualization-text-container text-[150px] sm:text-[250px] font-extrabold transition-all duration-75">
            <span class="beat-number-main text-gray-700 transition-all duration-75 transform scale-100">1</span>
        </div>
    </div>

    <!-- Quadrant 2: å³ä¸Š (Beat 2) -->
    <div data-beat="2" id="visual_2" class="beat-quadrant flex items-center justify-center rounded-xl transition-colors duration-150">
        <div class="visualization-text-container text-[150px] sm:text-[250px] font-extrabold transition-all duration-75">
            <span class="beat-number-main text-gray-700 transition-all duration-75 transform scale-100">2</span>
        </div>
    </div>
    
    <!-- Quadrant 4: å·¦ä¸‹ (Beat 4) - ä½æ–¼ç¬¬ä¸‰å€‹ä½ç½® (ç¶²æ ¼çš„å·¦ä¸‹æ–¹) -->
    <div data-beat="4" id="visual_4" class="beat-quadrant flex items-center justify-center rounded-xl transition-colors duration-150">
        <div class="visualization-text-container text-[150px] sm:text-[250px] font-extrabold transition-all duration-75">
            <span class="beat-number-main text-gray-700 transition-all duration-75 transform scale-100">4</span>
        </div>
    </div>
    
    <!-- Quadrant 3: å³ä¸‹ (Beat 3) - ä½æ–¼ç¬¬å››å€‹ä½ç½® (ç¶²æ ¼çš„å³ä¸‹æ–¹) -->
    <div data-beat="3" id="visual_3" class="beat-quadrant flex items-center justify-center rounded-xl transition-colors duration-150">
        <div class="visualization-text-container text-[150px] sm:text-[250px] font-extrabold transition-all duration-75">
            <span class="beat-number-main text-gray-700 transition-all duration-75 transform scale-100">3</span>
        </div>
    </div>
</div>

<script type="module">
    // Web Audio API ç›¸é—œè®Šæ•¸
    let audioContext;
    let isPlaying = false;
    let lookahead = 25.0; // å¦‚ä½•æå‰æ’ç¨‹ (ms)
    let scheduleAheadTime = 0.1; // æå‰æ’ç¨‹çš„ç§’æ•¸ (s)
    let nextNoteTime = 0.0; // ä¸‹ä¸€å€‹ç¯€æ‹çš„æ™‚é–“é»

    // ç¯€æ‹å™¨ç‹€æ…‹è®Šæ•¸
    let bpm = 120;
    let beatsPerMeasure = 4;
    let currentBeat = 0; // The current beat number (1-4)
    let isDrumMode = false; // é¼“ç¯€å¥æ¨¡å¼ç‹€æ…‹
    let isVisualizationMode = false; // è¦–è¦ºåŒ–æ¨¡å¼ç‹€æ…‹
    let isFullscreenDisabled = false; // æ–°å¢: é–å®šå…¨è¢å¹•æ¨¡å¼ç‹€æ…‹ (false = è‡ªå‹•å…¨è¢å¹•é–‹å•Ÿ)
    
    // æ¯å€‹ç¯€æ‹çš„ç´°åˆ†æ¨¡å¼ (0: 1x, 1: 2x, 2: 4x, 3: ä¸‰é€£éŸ³, 4: Mute)
    let beatSubdivisions = new Array(beatsPerMeasure).fill(0); 

    // æ¨¡å¼æ¨™ç±¤ç”¨æ–¼ UI é¡¯ç¤º
    const SUBDIVISION_LABELS = {
        0: `<span class="text-lg font-extrabold relative top-[-1px]">1</span>`, // 1x
        1: `<span class="text-lg font-extrabold relative top-[-1px]">2</span>`, // 2x (å…«åˆ†éŸ³ç¬¦)
        2: `<span class="text-lg font-extrabold relative top-[-1px]">4</span>`, // 4x (åå…­åˆ†éŸ³ç¬¦)
        3: `<span class="text-lg font-extrabold relative top-[-1px]">3</span>`, // 3é€£éŸ³
        4: `<span class="text-xl font-extrabold text-red-500">M</span>`, // Mute
    };
    
    // é¼“æ¨¡å¼éŸ³è‰²å¸¸æ•¸
    const DRUM_KICK_FREQ = 80.0;     
    const DRUM_SNARE_FREQ = 200.0;   
    const DRUM_SNARE_DURATION = 0.1; 
    
    // åŸç‰ˆç¯€æ‹å™¨éŸ³è‰²å¸¸æ•¸
    const METRONOME_STRONG_FREQ = 600.0;
    const METRONROME_WEAK_FREQ = 400.0;
    const METRONOME_DURATION = 0.05; 
    const METRONOME_SUB_FREQ = 350.0; 
    const SUBDIVISION_VOLUME_MULTIPLIER = 0.8; 

    // SVG ä»£ç¢¼ (æ–°çš„å…¨è¢å¹•åˆ‡æ›åœ–ç¤º)
    // Eye Closed (é–å®šæ™‚é¡¯ç¤ºï¼Œæ„å³é—œé–‰è‡ªå‹•å…¨è¢å¹•åŠŸèƒ½)
    const SVG_EYE_CLOSED = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="m15 18-.722-3.25"/><path d="M2 8a10.645 10.645 0 0 0 20 0"/><path d="m20 15-1.726-2.05"/><path d="m4 15 1.726-2.05"/><path d="m9 18 .722-3.25"/></svg>`;
    // Eye Open (è§£é–æ™‚é¡¯ç¤ºï¼Œæ„å³é–‹å•Ÿè‡ªå‹•å…¨è¢å¹•åŠŸèƒ½)
    const SVG_EYE_OPEN = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>`;


    // DOM å…ƒç´ 
    const appContainer = document.getElementById('app');
    const visualizationScreen = document.getElementById('visualizationScreen');
    const startButton = document.getElementById('startButton');
    const bpmInput = document.getElementById('bpmInput');
    const bpmDisplay = document.getElementById('bpmDisplay');
    const beatIndicators = Array.from(document.querySelectorAll('.beat-indicator'));
    const tapTempoInfo = document.getElementById('tapTempoInfo');
    const drumModeToggle = document.getElementById('drumModeToggle'); // ä¿®æ­£: ä½¿ç”¨æ­£ç¢ºçš„ ID
    const drumIcon = document.getElementById('drumIcon');
    const fullscreenLockToggle = document.getElementById('fullscreenLockToggle'); 
    const fullscreenIconContainer = document.getElementById('fullscreenIconContainer'); // æ–°å¢: åœ–ç¤ºå®¹å™¨
    let intervalTimer = null;

    // è¦–è¦ºåŒ–è±¡é™å…ƒç´ åƒè€ƒ (é€é ID ç¢ºä¿æ­£ç¢ºå°æ‡‰ç¯€æ‹)
    const visualizationElements = {
        1: document.getElementById('visual_1'),
        2: document.getElementById('visual_2'),
        3: document.getElementById('visual_3'), 
        4: document.getElementById('visual_4'), 
    };

    // Tap Tempo è®Šæ•¸
    let tapHistory = [];
    const TAP_RESET_THRESHOLD = 2000; 
    
    // ------------------------------------------
    // --- è‡ªå‹•å…¨è¢å¹•è®Šæ•¸ (Auto Fullscreen) ---
    // ------------------------------------------
    let autoFullscreenTimeout = null;
    const AUTO_FULLSCREEN_DELAY = 3000; // 3 ç§’

    /**
     * åˆå§‹åŒ– AudioContextã€‚
     */
    function initializeAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    /**
     * åœ¨æŒ‡å®šæ™‚é–“æ’­æ”¾ä¸€å€‹é»æ“ŠéŸ³æ•ˆã€‚
     */
    function playClick(time, pitch, duration, volume = 1.0) {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine'; 
        oscillator.frequency.setValueAtTime(pitch, time); 

        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(volume, time); 
        gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.start(time);
        oscillator.stop(time + duration);
    }

    /**
     * æ’ç¨‹ä¸‹ä¸€å€‹ç¯€æ‹ä¸¦æ›´æ–°ç‹€æ…‹ã€‚
     */
    function scheduler() {
        while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
            
            const secondsPerBeat = 60.0 / bpm;
            
            // æ¯æ¬¡æ’ç¨‹éƒ½æ›´æ–°ä¸»ç¯€æ‹
            currentBeat = (currentBeat % beatsPerMeasure) + 1;
            const beatIndex = currentBeat - 1; 
            const subdivisionMode = beatSubdivisions[beatIndex]; 

            // 2. è²éŸ³é‚è¼¯
            let subdivisionCount = 1; 
            
            if (subdivisionMode === 1) subdivisionCount = 2;       // 2x (å…«åˆ†éŸ³ç¬¦)
            else if (subdivisionMode === 2) subdivisionCount = 4;  // 4x (åå…­åˆ†éŸ³ç¬¦)
            else if (subdivisionMode === 3) subdivisionCount = 3;  // 3x (ä¸‰é€£éŸ³)
            else if (subdivisionMode === 4) subdivisionCount = 0;  // éœéŸ³

            
            if (subdivisionCount > 0) {
                const subDuration = secondsPerBeat / subdivisionCount;

                for (let i = 0; i < subdivisionCount; i++) {
                    const clickTime = nextNoteTime + i * subDuration;
                    
                    const subStep = i; // 0 for main beat, 1, 2, 3 for subdivisions

                    // 1. è¦–è¦ºæ›´æ–°ï¼šåœ¨æ¯å€‹ç´°åˆ†éŸ³ç™¼å‡ºæ™‚è§¸ç™¼ä¸€æ¬¡é–ƒçˆ
                    updateVisuals(currentBeat, subStep, subdivisionMode);
                    
                    let pitch;
                    let duration;
                    let volumeMultiplier; 
                    
                    const isMainBeatClick = (i === 0);

                    if (isMainBeatClick) {
                        volumeMultiplier = 1.0; 
                    } else {
                        volumeMultiplier = SUBDIVISION_VOLUME_MULTIPLIER;
                    }


                    if (isDrumMode) {
                        if (isMainBeatClick) {
                            pitch = (currentBeat === 1 || currentBeat === 3) ? DRUM_KICK_FREQ : DRUM_SNARE_FREQ;
                            duration = (currentBeat === 2 || currentBeat === 4) ? DRUM_SNARE_DURATION : METRONOME_DURATION;
                        } else {
                            pitch = 800.0; 
                            duration = METRONOME_DURATION * 0.3;
                        }
                    } else {
                        duration = METRONOME_DURATION; 
                        if (currentBeat === 1 && isMainBeatClick) {
                            pitch = METRONOME_STRONG_FREQ; 
                        } else if (isMainBeatClick) {
                            pitch = METRONROME_WEAK_FREQ; 
                        } else {
                            pitch = METRONOME_SUB_FREQ; 
                        }
                    }
                    
                    playClick(clickTime, pitch, duration, volumeMultiplier);
                }
            } else {
                // å¦‚æœæ˜¯éœéŸ³æ¨¡å¼ (Mode 4)ï¼Œè²éŸ³ä¸ç™¼å‡ºï¼Œä½†è¦–è¦ºå¿…é ˆé–ƒçˆä¸€æ¬¡ã€‚
                // å‚³é -1 ä½œç‚º subStep ä»¥ç¢ºä¿è¦–è¦ºåŒ–é‚è¼¯è§¸ç™¼å–®æ¬¡é–ƒçˆã€‚
                updateVisuals(currentBeat, -1, subdivisionMode); 
            }

            nextNoteTime += secondsPerBeat;
        }
    }

    /**
     * è¦–è¦ºä¸Šé–ƒçˆç•¶å‰çš„ç¯€æ‹æŒ‡ç¤ºç‡ˆä¸¦æ›´æ–°å¤§æ•¸å­—é¡¯ç¤ºã€‚
     * @param {number} beat - ç•¶å‰çš„ç¯€æ‹æ•¸ (1 åˆ° beatsPerMeasure)ã€‚
     * @param {number} subdivisionStep - ç•¶å‰çš„ç´°åˆ†æ­¥æ•¸ (0: ä¸»è¦ç¯€æ‹, 1, 2, 3: ç´°åˆ†æ­¥, -1: éœéŸ³ç¯€æ‹)ã€‚
     * @param {number} subdivisionMode - ç´°åˆ†æ¨¡å¼ (0=1x, 1=2x, 2=4x, 3=3x, 4=Mute)ã€‚
     */
    function updateVisuals(beat, subdivisionStep, subdivisionMode) {
        // è¨ˆç®—åˆ°æ’­æ”¾æ™‚é–“çš„å»¶é² (ms)
        const delay = (nextNoteTime - audioContext.currentTime) * 1000;

        // å°‡è¦–è¦ºæ›´æ–°æ’ç¨‹åœ¨æº–ç¢ºçš„æ’­æ”¾æ™‚é–“
        setTimeout(() => {
            const animationDuration = 75; // è¦–è¦ºå‹•ç•«çš„æŒçºŒæ™‚é–“ (ms)
            
            // ---------------------------------
            // --- 1. å°æŒ‡ç¤ºç‡ˆé‚è¼¯ (åªåœ¨ä¸»æ‹é–ƒçˆ) ---
            // ---------------------------------
            // é€™å€‹é‚è¼¯æ˜¯æ­£ç¢ºçš„ï¼Œåªåœ¨ subdivisionStep === 0 æ™‚è§¸ç™¼é–ƒçˆä¸€æ¬¡ã€‚
            beatIndicators.forEach((indicator, index) => {
                indicator.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'opacity-100');
                if (beatSubdivisions[index] !== 4) { 
                    indicator.classList.remove('bg-gray-900', 'opacity-50');
                    indicator.classList.add('bg-gray-600');
                }
            });

            // é»äº®ç•¶å‰ç¯€æ‹çš„å°æŒ‡ç¤ºç‡ˆ
            const indicator = document.querySelector(`.beat-indicator[data-beat="${beat}"]`);
            const beatIndex = beat - 1;
            
            if (indicator && subdivisionStep === 0) { // åªåœ¨ä¸»ç¯€æ‹ (subdivisionStep === 0) é»äº®å°æŒ‡ç¤ºç‡ˆ
                const colorClass = (beat === 1) ? 'bg-[#ff5733]' : 'bg-[#ffc300]';

                if (beatSubdivisions[beatIndex] !== 4) { 
                    indicator.classList.remove('bg-gray-600');
                    indicator.classList.add(colorClass, 'opacity-100');
                }
            }
            
            // ------------------------------------
            // --- 2. å…¨è¢å¹•å››è±¡é™è¦–è¦ºåŒ–é‚è¼¯ (æ¯æ‹å›ºå®šé–ƒçˆä¸€æ¬¡) ---
            // ------------------------------------
            if (isVisualizationMode) {
                const allQuadrants = document.querySelectorAll('.beat-quadrant');
                
                // åˆ¤æ–·æ˜¯å¦ç‚ºä¸»è¦é–ƒçˆäº‹ä»¶ (å³æ¯æ‹çš„é–‹å§‹ï¼ŒåŒ…å«éœéŸ³æ‹)
                const isMainFlash = subdivisionStep === 0 || subdivisionStep === -1; 
                
                if (isMainFlash) { // åªæœ‰åœ¨ä¸»è¦ç¯€æ‹äº‹ä»¶ç™¼ç”Ÿæ™‚æ‰é–ƒçˆ
                    
                    // --- A. é‡ç½®æ‰€æœ‰å…ƒç´  (ä¿®æ­£: åªåœ¨ä¸»æ‹æ™‚é‡ç½®ï¼Œé¿å…ç´°åˆ†æ‹å°è‡´é–ƒçˆè¢«ç«‹å³å–æ¶ˆ) ---
                    // é‡ç½®æ‰€æœ‰æ–‡å­—é¡è‰²å’Œç¸®æ”¾ (ç”¨æ–¼ç†„æ»…ä¸Šä¸€æ‹æˆ–ç´°åˆ†æ‹çš„è¦–è¦ºæ•ˆæœ)
                    document.querySelectorAll('.beat-number-main').forEach(textEl => {
                        textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
                        textEl.classList.add('text-gray-700');
                    });
                    
                    // é‡ç½®æ‰€æœ‰è±¡é™èƒŒæ™¯
                    allQuadrants.forEach(quadrant => {
                        quadrant.classList.remove('bg-[#4a4768]'); 
                    });
                    
                    // --- B. è§¸ç™¼ç•¶å‰æ‹çš„é–ƒçˆ ---
                    const currentElement = visualizationElements[beat];
                    if (currentElement) {
                        const numberColor = (beat === 1) ? 'text-red-400' : 'text-[#9a7dff]';
                        const mainNumber = currentElement.querySelector('.beat-number-main');
                        
                        // 1. é»äº®è±¡é™èƒŒæ™¯
                        currentElement.classList.add('bg-[#4a4768]'); 

                        // 2. é»äº®ä¸»æ•¸å­— (é€™æ˜¯é–ƒçˆçš„å‹•ä½œ)
                        if (mainNumber) {
                            mainNumber.classList.remove('text-gray-700');
                            mainNumber.classList.add('text-white', numberColor, 'scale-105');
                            
                            // æ’ç¨‹é‡ç½®ç¸®æ”¾å‹•ç•« (é–ƒçˆ OFF)
                            setTimeout(() => {
                                mainNumber.classList.remove('scale-105'); 
                            }, animationDuration); 
                        }
                    }
                }
                // å¦‚æœ subdivisionStep > 0 (ç´°åˆ†æ‹)ï¼Œå‰‡ä¸åšä»»ä½•äº‹ï¼Œå¯¦ç¾å–®æ¬¡é–ƒçˆ
            }
        }, delay > 0 ? delay : 0);
    }

    /**
     * é¡¯ç¤ºå…¨è¢å¹•è¦–è¦ºåŒ–æ¨¡å¼
     */
    function showVisualization() {
        // æª¢æŸ¥æ˜¯å¦é–å®šå…¨è¢å¹•ï¼Œå¦‚æœæ˜¯ï¼Œå‰‡ç›´æ¥è¿”å›
        if (!isPlaying || isFullscreenDisabled) return; 
        
        clearTimeout(autoFullscreenTimeout); // é€²å…¥è¦–è¦ºåŒ–æ™‚æ¸…é™¤è¨ˆæ™‚å™¨
        
        isVisualizationMode = true;
        appContainer.classList.add('hidden');
        visualizationScreen.classList.remove('hidden');
        
        // ç¢ºä¿åˆå§‹ç‹€æ…‹æ˜¯æš—çš„
        document.querySelectorAll('.beat-number-main').forEach(textEl => {
            textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
            textEl.classList.add('text-gray-700');
        });
        document.querySelectorAll('.beat-quadrant').forEach(quadrant => {
            quadrant.classList.remove('bg-[#4a4768]');
        });
    }

    /**
     * éš±è—å…¨è¢å¹•è¦–è¦ºåŒ–æ¨¡å¼
     */
    function hideVisualization() {
        isVisualizationMode = false;
        visualizationScreen.classList.add('hidden');
        appContainer.classList.remove('hidden');

        // é‡ç½®æ‰€æœ‰è±¡é™ç‹€æ…‹ (æš—ä¸‹ä¾†)
        document.querySelectorAll('.beat-number-main').forEach(textEl => {
            textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
            textEl.classList.add('text-gray-700');
        });
        document.querySelectorAll('.beat-quadrant').forEach(quadrant => {
            quadrant.classList.remove('bg-[#4a4768]');
        });
        
        // ------------------------------------------
        // --- è¨­å®šè‡ªå‹•å…¨è¢å¹•è¨ˆæ™‚å™¨ ---
        // ------------------------------------------
        // åªæœ‰åœ¨æœªé–å®šå…¨è¢å¹•æ™‚æ‰è¨­å®šè‡ªå‹•åˆ‡æ›è¨ˆæ™‚å™¨
        if (isPlaying && !isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout); // æ¸…é™¤ä»»ä½•å…ˆå‰çš„è¨ˆæ™‚å™¨
            autoFullscreenTimeout = setTimeout(() => {
                showVisualization();
            }, AUTO_FULLSCREEN_DELAY); 
        }
    }

    /**
     * åˆ‡æ›å…¨è¢å¹•é–å®šæ¨¡å¼ã€‚
     */
    window.toggleFullscreenLock = function() {
        isFullscreenDisabled = !isFullscreenDisabled;

        if (isFullscreenDisabled) {
            // é–å®šç‹€æ…‹ï¼šAuto Fullscreen OFF (Active State)
            // é¡¯ç¤º Eye Closed (ğŸ”’ é–‰çœ¼ï¼šè¡¨ç¤ºåŠŸèƒ½è¢«é–å®šï¼Œä¸æœƒåˆ‡æ›)
            fullscreenIconContainer.innerHTML = SVG_EYE_CLOSED; 
            fullscreenIconContainer.classList.remove('text-gray-400'); 
            fullscreenIconContainer.classList.add('text-[#9a7dff]'); // ä½¿ç”¨ä¸»è‰²è¡¨ç¤ºå·²é–å®š
            fullscreenLockToggle.classList.remove('bg-[#4a4768]');
            fullscreenLockToggle.classList.add('bg-[#6a5acd]'); 
            fullscreenLockToggle.title = 'è§£é–è‡ªå‹•å…¨è¢å¹• (F)';
            
            clearTimeout(autoFullscreenTimeout); 
            
            if (isVisualizationMode) {
                hideVisualization();
            }
        } else {
            // è§£é–ç‹€æ…‹ï¼šAuto Fullscreen ON (Inactive/Default State)
            // é¡¯ç¤º Eye Open (ğŸ‘ï¸ é–‹çœ¼ï¼šè¡¨ç¤ºåŠŸèƒ½é–‹å•Ÿï¼Œå…è¨±è‡ªå‹•åˆ‡æ›)
            fullscreenIconContainer.innerHTML = SVG_EYE_OPEN; 
            fullscreenIconContainer.classList.remove('text-[#9a7dff]'); 
            fullscreenIconContainer.classList.add('text-gray-400'); // ä½¿ç”¨ç°è‰²è¡¨ç¤ºæœªé–å®š (è‡ªå‹•æ¨¡å¼)
            fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
            fullscreenLockToggle.classList.add('bg-[#4a4768]');
            fullscreenLockToggle.title = 'é–å®šè‡ªå‹•å…¨è¢å¹• (F)';

            if (isPlaying) {
                hideVisualization(); 
            }
        }
    }


    // é»æ“Šå…¨è¢å¹•æ™‚ï¼Œé€€å‡ºè¦–è¦ºåŒ–æ¨¡å¼
    visualizationScreen.addEventListener('click', () => {
        hideVisualization();
    });

    /**
     * é–‹å§‹æˆ–åœæ­¢ç¯€æ‹å™¨ã€‚
     */
    window.startStop = function() {
        initializeAudio();

        if (isPlaying) {
            // åœæ­¢
            clearInterval(intervalTimer);
            isPlaying = false;
            hideVisualization(); // å¦‚æœåœ¨è¦–è¦ºåŒ–æ¨¡å¼ï¼Œé€€å‡º (é€™æœƒæ¸…é™¤è¨ˆæ™‚å™¨)
            clearTimeout(autoFullscreenTimeout); // åœæ­¢æ™‚æ¸…é™¤è¨ˆæ™‚å™¨
            
            startButton.textContent = 'é–‹å§‹';
            startButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');
            startButton.classList.add('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            
            // é‡ç½®è¦–è¦ºæŒ‡ç¤ºç‡ˆé¡è‰²
            beatIndicators.forEach((indicator, index) => {
                indicator.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'opacity-100');
                if (beatSubdivisions[index] !== 4) {
                    indicator.classList.add('bg-gray-600');
                    indicator.classList.remove('bg-gray-900', 'opacity-50');
                } else {
                    indicator.classList.add('bg-gray-900', 'opacity-50');
                    indicator.classList.remove('bg-gray-600');
                }
            });
            
            currentBeat = 0;

        } else {
            // é–‹å§‹
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            isPlaying = true;
            startButton.textContent = 'åœæ­¢';
            startButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            startButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');

            currentBeat = 0;
            nextNoteTime = audioContext.currentTime;
            
            // å•Ÿå‹•æ’ç¨‹å™¨é–“éš”
            intervalTimer = setInterval(scheduler, lookahead);

            // 1ç§’å¾Œå˜—è©¦åˆ‡æ›åˆ°è¦–è¦ºåŒ–ç•«é¢ (å¦‚æœæœªé–å®š)
            if (!isFullscreenDisabled) {
                setTimeout(showVisualization, 1000);
            }
        }
    }

    /**
     * æ›´æ–° BPM å€¼ä¸¦å°‡å…¶é™åˆ¶åœ¨åˆç†ç¯„åœã€‚
     */
    window.updateBPM = function(newBPM) {
        const parsedBPM = parseInt(newBPM, 10);
        if (isNaN(parsedBPM)) return;

        let clampedBPM = Math.max(40, Math.min(240, parsedBPM));
        bpm = clampedBPM;
        
        bpmDisplay.textContent = bpm;
        bpmInput.value = bpm;
    }

    /**
     * é€éæŒ‰éˆ•æ”¹è®Š BPMã€‚
     */
    window.changeBPM = function(delta) {
        let newBPM = bpm + delta;
        updateBPM(newBPM);
    }

    /**
     * è™•ç†æ»‘é¼ é»æ“Šæˆ–ç©ºç™½éµæŒ‰ä¸‹äº‹ä»¶ä¾†è¨ˆç®—ç¯€æ‹é€Ÿåº¦ (Tap Tempo)ã€‚
     */
    window.handleTap = function() {
        const now = Date.now();
        let calculatedBPM = null;
        let infoMessage = 'é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹';

        if (tapHistory.length > 0) {
            const lastTap = tapHistory[tapHistory.length - 1];
            const interval = now - lastTap;

            if (interval > TAP_RESET_THRESHOLD) {
                tapHistory = [now]; 
                infoMessage = "åµæ¸¬é–‹å§‹... (å·²é‡ç½®)";
                tapTempoInfo.textContent = infoMessage;
                return;
            }

            tapHistory.push(now);

            if (tapHistory.length > 8) {
                tapHistory.shift();
            }

            if (tapHistory.length >= 2) {
                let totalInterval = 0;
                for (let i = 1; i < tapHistory.length; i++) {
                    totalInterval += tapHistory[i] - tapHistory[i - 1];
                }

                const averageInterval = totalInterval / (tapHistory.length - 1);
                calculatedBPM = Math.round(60000 / averageInterval);

                infoMessage = `æœ€è¿‘ ${tapHistory.length - 1} æ¬¡é–“éš”çš„å¹³å‡ BPMï¼š${calculatedBPM}`;
            }
            
        } else {
            tapHistory.push(now);
            infoMessage = "åµæ¸¬é–‹å§‹... (è«‹é»æ“Šç¬¬äºŒæ¬¡)";
        }

        if (calculatedBPM !== null) {
            const clampedBPM = Math.max(40, Math.min(240, calculatedBPM));
            updateBPM(clampedBPM);
        }
        
        tapTempoInfo.textContent = infoMessage;
    };


    /**
     * åˆ‡æ›é¼“ç¯€å¥æ¨¡å¼ã€‚
     */
    window.toggleDrumMode = function() {
        isDrumMode = !isDrumMode;

        if (isDrumMode) {
            drumIcon.classList.remove('text-gray-400');
            drumIcon.classList.add('text-[#ffc300]'); 
            drumModeToggle.classList.remove('bg-[#4a4768]');
            drumModeToggle.classList.add('bg-[#6a5acd]'); 
            drumModeToggle.title = 'åˆ‡æ›è‡³ç¯€æ‹å™¨æ¨¡å¼ (D)';
        } else {
            drumIcon.classList.remove('text-[#ffc300]');
            drumIcon.classList.add('text-gray-400');
            drumModeToggle.classList.remove('bg-[#6a5acd]');
            drumModeToggle.classList.add('bg-[#4a4768]');
            drumModeToggle.title = 'åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)';
        }

        if (isPlaying) {
            // é‡å•Ÿä»¥æ‡‰ç”¨æ–°çš„éŸ³è‰²é‚è¼¯
            window.startStop(); 
            window.startStop(); 
        }
    }

    /**
     * é»æ“Šç¯€æ‹æŒ‡ç¤ºç‡ˆä»¥å¾ªç’°åˆ‡æ›ç´°åˆ†æ¨¡å¼ã€‚
     */
    window.toggleSubdivision = function(beatIndex) {
        initializeAudio(); 

        let currentMode = beatSubdivisions[beatIndex];
        let newMode = (currentMode + 1) % 5; 

        beatSubdivisions[beatIndex] = newMode;
        
        const indicator = beatIndicators[beatIndex];
        const modeTextSpan = indicator.querySelector('.mode-text');
        
        modeTextSpan.innerHTML = SUBDIVISION_LABELS[newMode];

        if (newMode === 4) {
             indicator.classList.remove('bg-gray-600', 'bg-[#ff5733]', 'bg-[#ffc300]');
             indicator.classList.add('bg-gray-900', 'opacity-50');
        } else {
             indicator.classList.remove('bg-gray-900', 'opacity-50');
             indicator.classList.add('bg-gray-600');
        }
        
        if (isPlaying) {
            // é‡å•Ÿä»¥æ‡‰ç”¨æ–°çš„ç´°åˆ†é‚è¼¯ (å› ç‚º scheduler éœ€è¦é‡æ–°è¨ˆç®—)
            window.startStop(); 
            window.startStop(); 
        }
    };


    // ------------------------------------------
    // --- å•Ÿç”¨è‡ªå‹•å…¨è¢å¹•é‡å•Ÿçš„æ»‘é¼ ç§»å‹•ç›£è½ ---
    // ------------------------------------------
    appContainer.addEventListener('mousemove', () => {
        // åªæœ‰åœ¨æ’­æ”¾ä¸­ã€ä¸åœ¨è¦–è¦ºåŒ–æ¨¡å¼ã€ä¸”æœªé–å®šå…¨è¢å¹•æ™‚ï¼Œæ‰é‡è¨­è¨ˆæ™‚å™¨
        if (isPlaying && !isVisualizationMode && !isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout);
            autoFullscreenTimeout = setTimeout(() => {
                showVisualization();
            }, AUTO_FULLSCREEN_DELAY);
        }
    });


    // éµç›¤äº‹ä»¶ç›£è½å™¨ (è™•ç†ç©ºç™½éµ (Tap Tempo), D éµ (Drum Mode), F éµ (Fullscreen Lock))
    document.addEventListener('keydown', (event) => {
        // å¦‚æœåœ¨è¼¸å…¥æ¡†ä¸­ï¼Œå‰‡è·³é
        if (event.target.tagName === 'INPUT') {
            return;
        }
        
        // å¦‚æœåœ¨è¦–è¦ºåŒ–æ¨¡å¼ä¸‹ï¼Œä»»ä½•æŒ‰éµè¡Œç‚ºéƒ½ç­‰æ–¼é»æ“Šï¼Œé€€å‡ºè¦–è¦ºåŒ–
        if (isVisualizationMode && event.code !== 'Space' && event.code !== 'KeyD' && event.code !== 'KeyF') {
            event.preventDefault();
            hideVisualization();
            return;
        }

        if (event.code === 'Space') {
            event.preventDefault(); 
            handleTap();
        } else if (event.code === 'KeyD') {
            event.preventDefault(); 
            toggleDrumMode();
        } else if (event.code === 'KeyF') { // æ–°å¢ F éµ
            event.preventDefault(); 
            toggleFullscreenLock();
        }
    });


    // åˆå§‹è¼‰å…¥æ™‚è¨­å®š BPM é¡¯ç¤ºã€ç´°åˆ†æ¨¡å¼é¡¯ç¤ºã€ä»¥åŠå…¨è¢å¹•é–å®šç‹€æ…‹
    document.addEventListener('DOMContentLoaded', () => {
        updateBPM(bpm);
        drumModeToggle.title = 'åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)';
        
        // ç¢ºä¿ isFullscreenDisabled é è¨­ç‚º false (è‡ªå‹•å…¨è¢å¹• ON)
        isFullscreenDisabled = false;
        
        // åˆå§‹è¨­å®šç‚ºã€Œè§£é–ã€ç‹€æ…‹ (ç¾åœ¨é¡¯ç¤º Eye Open)
        fullscreenIconContainer.innerHTML = SVG_EYE_OPEN; 
        fullscreenIconContainer.classList.remove('text-[#9a7dff]'); 
        fullscreenIconContainer.classList.add('text-gray-400'); 
        fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
        fullscreenLockToggle.classList.add('bg-[#4a4768]');
        fullscreenLockToggle.title = 'é–å®šè‡ªå‹•å…¨è¢å¹• (F)';


        beatIndicators.forEach((indicator, index) => {
            const modeTextSpan = indicator.querySelector('.mode-text');
            if (modeTextSpan) {
                modeTextSpan.innerHTML = SUBDIVISION_LABELS[beatSubdivisions[index]];
            }
        });
    });

</script>

</body>
</html>