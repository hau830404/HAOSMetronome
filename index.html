<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯€æ‹å™¨ (Metronome)</title>
    <!-- è¼‰å…¥ Tailwind CSS æ¡†æ¶ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®š Inter å­—é«”ï¼Œä»¥åŠæ‡‰ç”¨ç¨‹å¼çš„èƒŒæ™¯ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* æ·±è‰²èƒŒæ™¯ */
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px; /* ä¿æŒé©ç•¶é‚Šè· */
            overflow-y: auto;
            /* ç¦ç”¨æ–‡å­—åç™½é¸å–åŠŸèƒ½ */
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* è‡ªè¨‚æŒ‰éˆ•æ¨£å¼ */
        .metronome-button {
            transition: all 0.15s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border: 2px solid transparent;
        }

        .metronome-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .metronome-button:active {
            opacity: 0.7;
            transform: translateY(1px);
        }

        /* ç¯€æ‹å™¨å¡ç‰‡ */
        .metronome-card {
            background-color: #2c2a4a;
            border: 1px solid #4a4768;
            transition: transform 0.2s;
            max-width: 420px;
            width: 100%;
            /* é—œéµä¿®æ­£ï¼šå…è¨±å¡ç‰‡å…§éƒ¨å…§å®¹éé•·æ™‚æ»¾å‹• */
            overflow-y: auto;
            /* éš±è—å¡ç‰‡å…§éƒ¨çš„æ»¾å‹•æ¢ (Chrome/Safari) */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none;  /* IE 10+ */
        }
        .metronome-card::-webkit-scrollbar { 
            display: none;  /* Chrome/Safari */
        }

        /* æ‡‰ç”¨ç¨‹å¼ä¸»å®¹å™¨ (ç”¨æ–¼æ»‘å‹•) */
        #app-wrapper {
            max-width: 420px;
            width: 100%;
            /* å›ºå®šé«˜åº¦ */
            height: 700px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        /* ç¯€æ‹æŒ‡ç¤ºç‡ˆï¼šä½¿ç”¨ transition è®“é–ƒçˆæ›´å¹³æ»‘ */
        .beat-indicator {
            transition: background-color 0.1s;
        }

        /* éš±è—é è¨­çš„ input number ç®­é ­ï¼Œä¸¦å…è¨±æ–‡å­—é¸å– */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            user-select: auto; /* å…è¨±åœ¨è¼¸å…¥æ¡†å…§é¸å–æ–‡å­— */
        }

        /* è¦–è¦ºåŒ–è±¡é™çš„åŸºåº•æ¨£å¼ */
        .beat-quadrant {
            background-color: #2c2a4a; /* æš—è‰²èƒŒæ™¯ä½œç‚ºåº•åœ– */
            border: 1px solid #4a4768;
            transition: all 0.15s ease; /* è®“èƒŒæ™¯è®ŠåŒ–æ›´æµæš¢ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è¦–è¦ºåŒ–æ•¸å­—çš„åŸºåº•æ¨£å¼ */
        .visualization-text-container {
            /* é…åˆ JS ä¸­çš„ animationDuration */
            transition: all 0.075s ease-out; 
            will-change: transform, color; /* å¹«åŠ© GPU åŠ é€Ÿå‹•ç•« */
        }
    </style>
</head>
<body>

<!-- æ‡‰ç”¨ç¨‹å¼ä¸»å¡ç‰‡å®¹å™¨ (åŒ…å«å¤šé å¡ç‰‡) -->
<div id="app-wrapper" class="overflow-hidden relative shadow-2xl rounded-xl">
    <!-- å·¦å´åˆ‡æ›ç®­é ­ -->
    <button id="prevBtn" onclick="prevCard()" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 p-2 text-white/70 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
    </button>
    <!-- å³å´åˆ‡æ›ç®­é ­ -->
    <button id="nextBtn" onclick="nextCard()" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 p-2 text-white/70 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>
    </button>

    <!-- å¡ç‰‡å…§å®¹å®¹å™¨ (é€²è¡Œæ°´å¹³ç§»å‹•çš„å…ƒç´ ) -->
    <div id="card-container" class="flex transition-transform duration-300 ease-in-out" style="width: 200%;">
        
        <!-- å¡ç‰‡ 1: ç¯€æ‹å™¨ä¸»ç•«é¢ -->
        <div id="card-1" class="metronome-card p-6 md:p-8 rounded-xl shadow-2xl text-center flex-shrink-0 flex flex-col" style="width: 50%; height: 700px;">
            
            <!-- æ¨™é¡Œ -->
            <h1 class="text-3xl font-extrabold mb-2 text-[#9a7dff] flex-shrink-0">
                ğŸµ æ•¸ä½ç¯€æ‹å™¨
            </h1>

            <!-- ç¯€æ‹é¡¯ç¤ºå€ -->
            <div class="mb-4 flex-shrink-0">
                <span id="bpmDisplay" class="text-7xl font-mono font-bold text-white transition-colors duration-200">
                    120
                </span>
                <div class="text-lg text-gray-400 mt-1">
                    BPM
                </div>
            </div>

            <!-- BPM æ§åˆ¶å€ -->
            <div class="flex items-center justify-center space-x-4 mb-4 flex-shrink-0">
                <!-- æ¸›å°‘ BPM æŒ‰éˆ• -->
                <button onclick="changeBPM(-1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-3 rounded-full text-2xl font-bold w-12 h-12 flex items-center justify-center">
                    âˆ’
                </button>
                
                <!-- BPM è¼¸å…¥æ¡† -->
                <input type="number" id="bpmInput" value="120" min="40" max="240"
                       onchange="updateBPM(this.value)"
                       class="w-24 text-center text-3xl font-bold bg-[#4a4768] p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#9a7dff] transition-all duration-150 border border-[#6a5acd]">

                <!-- å¢åŠ  BPM æŒ‰éˆ• -->
                <button onclick="changeBPM(1)" class="metronome-button bg-[#6a5acd] hover:bg-[#5a4ba5] p-3 rounded-full text-2xl font-bold w-12 h-12 flex items-center justify-center">
                    ï¼‹
                </button>
            </div>

            <!-- æŒ‰éˆ•å®¹å™¨: Fullscreen Lock, Start/Stop & Drum Toggle -->
            <div class="flex space-x-2 mb-4 justify-center flex-shrink-0">
                <!-- é–å®šå…¨è¢å¹•æŒ‰éˆ• -->
                <button id="fullscreenLockToggle" onclick="toggleFullscreenLock()"
                        title="é–å®šè‡ªå‹•å…¨è¢å¹• (F)"
                        class="metronome-button w-1/5 py-4 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
                    <div id="fullscreenIconContainer" class="text-gray-400 transition-colors duration-150 w-7 h-7 flex items-center justify-center">
                        <!-- åˆå§‹åœ–ç¤ºå°‡ç”± JS æ³¨å…¥ -->
                    </div>
                </button>

                <!-- é–‹å§‹/åœæ­¢ æŒ‰éˆ• -->
                <button id="startButton" onclick="startStop()"
                        class="metronome-button w-3/5 py-4 text-xl font-bold rounded-xl bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-700">
                    é–‹å§‹
                </button>
                <!-- Drum Mode Toggle -->
                <button id="drumModeToggle" onclick="toggleDrumMode()"
                        title="åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)"
                        class="metronome-button w-1/5 py-4 rounded-xl bg-[#4a4768] hover:bg-[#5a577d] focus:outline-none focus:ring-4 focus:ring-[#9a7dff] flex items-center justify-center">
                    <svg id="drumIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 transition-colors duration-150">
                        <path d="m2 2 8 8"/><path d="m22 2-8 8"/><ellipse cx="12" cy="9" rx="10" ry="5"/><path d="M7 13.4v7.9"/><path d="M12 14v8"/><path d="M17 13.4v7.9"/><path d="M2 9v8a10 5 0 0 0 20 0V9"/>
                    </svg>
                </button>
            </div>

            <!-- Tap Tempo å€åŸŸ -->
            <div id="tapTempoArea" 
                 onclick="handleTap()"
                 class="p-3 bg-[#4a4768] rounded-xl cursor-pointer hover:bg-[#5a577d] transition-colors mb-4 border border-dashed border-[#6a5acd] active:scale-[0.99] flex-shrink-0">
                <p class="text-base font-semibold text-gray-200 uppercase tracking-wider">
                    TAP TEMPO
                </p>
                <p id="tapTempoInfo" class="text-xs text-gray-400 mt-1 h-3">
                    é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹
                </p>
            </div>

            <!-- æ‹æ•¸ (Beats per Measure) æ§åˆ¶å€ (æ–°å¢) -->
            <div class="flex items-center justify-center space-x-4 mb-2 flex-shrink-0">
                 <button onclick="changeBeats(-1)" class="w-8 h-8 rounded-full bg-[#4a4768] hover:bg-[#5a577d] flex items-center justify-center text-white font-bold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/></svg>
                </button>
                <div class="text-gray-300 font-semibold">
                    æ¯å°ç¯€ <span id="beatsDisplay" class="text-[#9a7dff] text-xl mx-1">4</span> æ‹
                </div>
                <button onclick="changeBeats(1)" class="w-8 h-8 rounded-full bg-[#4a4768] hover:bg-[#5a577d] flex items-center justify-center text-white font-bold transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                </button>
            </div>
            
            <!-- ç¯€æ‹æŒ‡ç¤ºç‡ˆ (å‹•æ…‹ç”Ÿæˆ) - é—œéµä¿®æ­£: flex-shrink-0 é˜²æ­¢è¢«å£“ç¸® -->
            <div id="beatIndicators" class="flex justify-center flex-wrap gap-3 mt-2 px-2 flex-shrink-0 pb-6">
                <!-- JS å°‡æœƒåœ¨é€™è£¡æ’å…¥æŒ‡ç¤ºç‡ˆ -->
            </div>
        </div>

        <!-- å¡ç‰‡ 2: è¨­å®šèˆ‡å·¥å…· (ç¯„ä¾‹é é¢) -->
        <div id="card-2" class="metronome-card p-6 md:p-8 rounded-xl shadow-2xl text-center flex-shrink-0" style="width: 50%; height: 700px;">
            <h2 class="text-3xl font-bold text-[#9a7dff] mb-4">è¨­å®šèˆ‡å·¥å…·</h2>
            <div class="text-gray-400">
                <p>æ‚¨å¯ä»¥åœ¨æ­¤è™•æ–°å¢å…¶ä»–åŠŸèƒ½æˆ–è¨­å®šã€‚</p>
                <div class="mt-8 p-4 bg-[#4a4768] rounded-lg">
                    <p class="font-semibold">ç•¶å‰é é¢ï¼š2 / 2</p>
                </div>
            </div>
        </div>

    </div>

    <!-- é é¢å°èˆªåœ“é» -->
    <div id="card-dots" class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2 z-10">
        <div data-index="0" class="card-dot w-3 h-3 rounded-full bg-white/40 cursor-pointer" onclick="goToCard(0)"></div>
        <div data-index="1" class="card-dot w-3 h-3 rounded-full bg-white/40 cursor-pointer" onclick="goToCard(1)"></div>
    </div>
</div>

<!-- è¦–è¦ºåŒ–å…¨è¢å¹•æ¨¡å¼ (å‹•æ…‹ç”Ÿæˆç¶²æ ¼) -->
<div id="visualizationScreen" 
     class="hidden fixed inset-0 z-50 p-4 sm:p-8 bg-gray-900/95 cursor-pointer grid gap-4 sm:gap-8"
     title="é»æ“Šä»»æ„è™•é€€å‡ºè¦–è¦ºåŒ–æ¨¡å¼">
     <!-- JS å°‡æœƒåœ¨é€™è£¡æ’å…¥ç¶²æ ¼ -->
</div>

<script type="module">
    // Web Audio API ç›¸é—œè®Šæ•¸
    let audioContext;
    let isPlaying = false;
    let lookahead = 25.0; // ms
    let scheduleAheadTime = 0.1; // s
    let nextNoteTime = 0.0; 

    // ç¯€æ‹å™¨ç‹€æ…‹è®Šæ•¸
    let bpm = 120;
    let beatsPerMeasure = 4; // å¯è®Šå‹•çš„æ‹æ•¸
    let currentBeat = 0; 
    let isDrumMode = false; 
    let isVisualizationMode = false; 
    let isFullscreenDisabled = false; 
    
    // æ¯å€‹ç¯€æ‹çš„ç´°åˆ†æ¨¡å¼
    let beatSubdivisions = new Array(beatsPerMeasure).fill(0); 

    // æ¨¡å¼æ¨™ç±¤ç”¨æ–¼ UI é¡¯ç¤º
    const SUBDIVISION_LABELS = {
        0: `<span class="text-lg font-extrabold relative top-[-1px]">1</span>`, 
        1: `<span class="text-lg font-extrabold relative top-[-1px]">2</span>`, 
        2: `<span class="text-lg font-extrabold relative top-[-1px]">4</span>`, 
        3: `<span class="text-lg font-extrabold relative top-[-1px]">3</span>`, 
        4: `<span class="text-xl font-extrabold text-red-500">M</span>`, 
    };
    
    // éŸ³è‰²å¸¸æ•¸
    const DRUM_KICK_FREQ = 80.0;     
    const DRUM_SNARE_FREQ = 200.0;   
    const DRUM_SNARE_DURATION = 0.1; 
    const METRONOME_STRONG_FREQ = 600.0;
    const METRONROME_WEAK_FREQ = 400.0;
    const METRONOME_DURATION = 0.05; 
    const METRONOME_SUB_FREQ = 350.0; 
    const SUBDIVISION_VOLUME_MULTIPLIER = 0.8; 

    // SVG ä»£ç¢¼
    const SVG_EYE_CLOSED = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="m15 18-.722-3.25"/><path d="M2 8a10.645 10.645 0 0 0 20 0"/><path d="m20 15-1.726-2.05"/><path d="m4 15 1.726-2.05"/><path d="m9 18 .722-3.25"/></svg>`;
    const SVG_EYE_OPEN = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-full h-full"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>`;

    // DOM å…ƒç´ 
    const appWrapper = document.getElementById('app-wrapper');
    const cardContainer = document.getElementById('card-container');
    const cardDots = document.querySelectorAll('.card-dot');
    const numCards = cardDots.length;
    let currentCardIndex = 0;
    
    const visualizationScreen = document.getElementById('visualizationScreen');
    const startButton = document.getElementById('startButton');
    const bpmInput = document.getElementById('bpmInput');
    const bpmDisplay = document.getElementById('bpmDisplay');
    const beatIndicatorsContainer = document.getElementById('beatIndicators'); // å®¹å™¨
    const beatsDisplay = document.getElementById('beatsDisplay'); // æ‹æ•¸é¡¯ç¤º
    const tapTempoInfo = document.getElementById('tapTempoInfo');
    const drumModeToggle = document.getElementById('drumModeToggle'); 
    const drumIcon = document.getElementById('drumIcon');
    const fullscreenLockToggle = document.getElementById('fullscreenLockToggle'); 
    const fullscreenIconContainer = document.getElementById('fullscreenIconContainer'); 
    let intervalTimer = null;

    // Tap Tempo
    let tapHistory = [];
    const TAP_RESET_THRESHOLD = 2000; 
    
    // Auto Fullscreen
    let autoFullscreenTimeout = null;
    const AUTO_FULLSCREEN_DELAY = 3000; 

    // ------------------------------------------
    // --- æ»‘å‹•/å°èˆªé‚è¼¯ ---
    // ------------------------------------------
    let isDragging = false;
    let startX = 0;
    let currentTranslate = 0;
    let prevTranslate = 0;
    const sensitivity = 50; 

    function setCardPosition(index) {
        currentCardIndex = Math.max(0, Math.min(index, numCards - 1));
        currentTranslate = currentCardIndex * (-100 / numCards); 
        cardContainer.style.transform = `translateX(${currentTranslate}%)`;
        
        cardDots.forEach((dot, i) => {
            dot.classList.remove('bg-white');
            dot.classList.add('bg-white/40');
            if (i === currentCardIndex) {
                dot.classList.add('bg-white');
            }
        });
        document.getElementById('prevBtn').style.display = currentCardIndex === 0 ? 'none' : 'block';
        document.getElementById('nextBtn').style.display = currentCardIndex === numCards - 1 ? 'none' : 'block';
    }

    window.goToCard = function(index) {
        cardContainer.style.transition = 'transform 0.3s ease-in-out';
        setCardPosition(index);
        setTimeout(() => { cardContainer.style.transition = 'none'; }, 300);
    }
    window.nextCard = function() { goToCard(currentCardIndex + 1); }
    window.prevCard = function() { goToCard(currentCardIndex - 1); }

    function getPositionX(event) {
        return event.type.includes('mouse') ? event.pageX : event.touches[0].clientX;
    }
    function touchStart(event) {
        isDragging = true;
        startX = getPositionX(event);
        prevTranslate = currentTranslate;
        cardContainer.style.transition = 'none'; 
    }
    function touchMove(event) {
        if (!isDragging) return;
        const currentX = getPositionX(event);
        const diff = currentX - startX;
        const translateAmount = (diff / appWrapper.offsetWidth) * (100 / numCards);
        currentTranslate = prevTranslate + translateAmount;
        const maxTranslate = 0;
        const minTranslate = (numCards - 1) * (-100 / numCards);
        currentTranslate = Math.max(minTranslate, Math.min(maxTranslate, currentTranslate));
        cardContainer.style.transform = `translateX(${currentTranslate}%)`;
    }
    function touchEnd() {
        if (!isDragging) return;
        isDragging = false;
        const movedBy = currentTranslate - prevTranslate;
        let targetIndex = currentCardIndex;
        if (movedBy < -sensitivity) { targetIndex += 1; } 
        else if (movedBy > sensitivity) { targetIndex -= 1; }
        cardContainer.style.transition = 'transform 0.3s ease-in-out';
        setCardPosition(targetIndex);
    }

    appWrapper.addEventListener('touchstart', touchStart, { passive: true });
    appWrapper.addEventListener('touchend', touchEnd);
    appWrapper.addEventListener('touchmove', touchMove, { passive: true });
    appWrapper.addEventListener('mousedown', touchStart);
    appWrapper.addEventListener('mouseup', touchEnd);
    appWrapper.addEventListener('mouseleave', () => { if (isDragging) touchEnd(); });
    appWrapper.addEventListener('mousemove', touchMove);

    // ------------------------------------------
    // --- æ‹æ•¸æ§åˆ¶é‚è¼¯ ---
    // ------------------------------------------
    
    window.changeBeats = function(delta) {
        let newBeats = beatsPerMeasure + delta;
        newBeats = Math.max(1, Math.min(12, newBeats));
        
        if (newBeats !== beatsPerMeasure) {
            beatsPerMeasure = newBeats;
            
            if (newBeats > beatSubdivisions.length) {
                const diff = newBeats - beatSubdivisions.length;
                for (let i = 0; i < diff; i++) {
                    beatSubdivisions.push(0);
                }
            } else {
                beatSubdivisions.length = newBeats;
            }
            renderUI();
        }
    }

    /**
     * æ ¹æ“šç•¶å‰ beatsPerMeasure æ¸²æŸ“ä¸»ç•«é¢æŒ‡ç¤ºç‡ˆèˆ‡å…¨è¢å¹•ç¶²æ ¼
     */
    function renderUI() {
        beatsDisplay.textContent = beatsPerMeasure;
        
        // 1. æ¸²æŸ“ä¸»ç•«é¢æŒ‡ç¤ºç‡ˆ
        beatIndicatorsContainer.innerHTML = '';
        for (let i = 1; i <= beatsPerMeasure; i++) {
            const indicator = document.createElement('div');
            // é—œéµä¿®æ­£: æ¢å¾©é»æ“ŠåŠŸèƒ½
            indicator.className = `beat-indicator w-12 h-12 rounded-full bg-gray-600 relative flex items-center justify-center cursor-pointer transform scale-100 flex-shrink-0 transition-all duration-100`;
            indicator.dataset.beat = i;
            // é€™è£¡ç¶å®šé»æ“Šäº‹ä»¶
            indicator.onclick = () => window.toggleSubdivision(i - 1);
            
            const mode = beatSubdivisions[i-1];
            const span = document.createElement('span');
            span.className = 'absolute font-bold text-white mode-text text-lg pointer-events-none'; // pointer-events-none ç¢ºä¿é»æ“Šç©¿é€åˆ° div
            span.innerHTML = SUBDIVISION_LABELS[mode];
            
            indicator.appendChild(span);
            beatIndicatorsContainer.appendChild(indicator);
        }
        
        // ç¢ºä¿æ¨™ç±¤ç‹€æ…‹æ­£ç¢º
        updateSubdivisionLabels();

        // 2. æ¸²æŸ“å…¨è¢å¹•ç¶²æ ¼
        visualizationScreen.innerHTML = '';
        let cols = Math.ceil(Math.sqrt(beatsPerMeasure));
        if (beatsPerMeasure === 2) cols = 2; 
        
        visualizationScreen.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
        
        for (let i = 1; i <= beatsPerMeasure; i++) {
            const quadrant = document.createElement('div');
            quadrant.className = 'beat-quadrant flex items-center justify-center rounded-xl transition-colors duration-150';
            quadrant.id = `visual_${i}`;
            quadrant.dataset.beat = i;
            
            const textContainer = document.createElement('div');
            textContainer.className = 'visualization-text-container text-[100px] sm:text-[200px] font-extrabold transition-all duration-75';
            if (beatsPerMeasure > 4) textContainer.classList.replace('text-[100px]', 'text-[60px]');
            if (beatsPerMeasure > 4) textContainer.classList.replace('sm:text-[200px]', 'sm:text-[120px]');
            
            const span = document.createElement('span');
            span.className = 'beat-number-main text-gray-700 transition-all duration-75 transform scale-100';
            span.textContent = i;
            
            textContainer.appendChild(span);
            quadrant.appendChild(textContainer);
            visualizationScreen.appendChild(quadrant);
        }
    }


    // ------------------------------------------
    // --- ç¯€æ‹å™¨æ ¸å¿ƒé‚è¼¯ ---
    // ------------------------------------------

    function initializeAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function playClick(time, pitch, duration, volume = 1.0) {
        if (!audioContext) return;
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine'; 
        oscillator.frequency.setValueAtTime(pitch, time); 
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(volume, time); 
        gainNode.gain.exponentialRampToValueAtTime(0.001, time + duration);
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start(time);
        oscillator.stop(time + duration);
    }

    function scheduler() {
        while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
            const secondsPerBeat = 60.0 / bpm;
            currentBeat = (currentBeat % beatsPerMeasure) + 1;
            const beatIndex = currentBeat - 1; 
            const subdivisionMode = beatSubdivisions[beatIndex]; 

            let subdivisionCount = 1; 
            if (subdivisionMode === 1) subdivisionCount = 2;
            else if (subdivisionMode === 2) subdivisionCount = 4;
            else if (subdivisionMode === 3) subdivisionCount = 3;
            else if (subdivisionMode === 4) subdivisionCount = 0;

            if (subdivisionCount >= 0) {
                const subDuration = (subdivisionCount > 0) ? secondsPerBeat / subdivisionCount : secondsPerBeat;
                const actualSubCount = subdivisionCount > 0 ? subdivisionCount : 1; 

                for (let i = 0; i < actualSubCount; i++) {
                    const clickTime = nextNoteTime + i * subDuration;
                    const subStep = (subdivisionCount === 0) ? -1 : i; 
                    updateVisuals(currentBeat, subStep, subdivisionMode);
                    
                    if (subdivisionCount === 0) continue; 
                    
                    let pitch;
                    let duration;
                    let volumeMultiplier; 
                    const isMainBeatClick = (i === 0);

                    if (isMainBeatClick) {
                        volumeMultiplier = 1.0; 
                    } else {
                        volumeMultiplier = SUBDIVISION_VOLUME_MULTIPLIER;
                    }

                    if (isDrumMode) {
                        if (isMainBeatClick) {
                            pitch = (currentBeat === 1 || currentBeat === 3) ? DRUM_KICK_FREQ : DRUM_SNARE_FREQ;
                            duration = (currentBeat === 2 || currentBeat === 4) ? DRUM_SNARE_DURATION : METRONOME_DURATION;
                        } else {
                            pitch = 800.0; 
                            duration = METRONOME_DURATION * 0.3;
                        }
                    } else {
                        duration = METRONOME_DURATION; 
                        if (currentBeat === 1 && isMainBeatClick) {
                            pitch = METRONOME_STRONG_FREQ; 
                        } else if (isMainBeatClick) {
                            pitch = METRONROME_WEAK_FREQ; 
                        } else {
                            pitch = METRONOME_SUB_FREQ; 
                        }
                    }
                    playClick(clickTime, pitch, duration, volumeMultiplier);
                }
            } 
            nextNoteTime += secondsPerBeat;
        }
    }

    function updateVisuals(beat, subdivisionStep, subdivisionMode) {
        const delay = (nextNoteTime - audioContext.currentTime) * 1000;

        setTimeout(() => {
            const animationDuration = 75; 
            
            // 1. å°æŒ‡ç¤ºç‡ˆé‚è¼¯
            const indicator = document.querySelector(`.beat-indicator[data-beat="${beat}"]`);
            
            // é‡ç½®æ‰€æœ‰æŒ‡ç¤ºç‡ˆé¡è‰²
            beatIndicatorsContainer.querySelectorAll('.beat-indicator').forEach((ind, index) => {
                ind.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'scale-110');
                if (beatSubdivisions[index] !== 4) { 
                    ind.classList.remove('bg-gray-900', 'opacity-50');
                    ind.classList.add('bg-gray-600');
                } else {
                    // Mute ç‹€æ…‹
                     ind.classList.remove('bg-gray-600');
                     ind.classList.add('bg-gray-900', 'opacity-50');
                }
            });
            
            if (indicator && subdivisionStep === 0) { 
                const colorClass = (beat === 1) ? 'bg-[#ff5733]' : 'bg-[#ffc300]';
                if (subdivisionMode !== 4) { 
                    indicator.classList.remove('bg-gray-600');
                    indicator.classList.add(colorClass, 'scale-110'); // é–ƒçˆ
                }
            }
            
            // 2. å…¨è¢å¹•è¦–è¦ºåŒ–é‚è¼¯
            if (isVisualizationMode) {
                const allQuadrants = document.querySelectorAll('.beat-quadrant');
                const isMainFlash = subdivisionStep === 0 || subdivisionStep === -1; 
                
                if (isMainFlash) { 
                    document.querySelectorAll('.beat-number-main').forEach(textEl => {
                        textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
                        textEl.classList.add('text-gray-700');
                    });
                    allQuadrants.forEach(quadrant => {
                        quadrant.classList.remove('bg-[#4a4768]'); 
                    });
                    
                    const currentElement = document.getElementById(`visual_${beat}`);
                    if (currentElement) {
                        const numberColor = (beat === 1) ? 'text-red-400' : 'text-[#9a7dff]';
                        const mainNumber = currentElement.querySelector('.beat-number-main');
                        
                        currentElement.classList.add('bg-[#4a4768]'); 

                        if (mainNumber) {
                            mainNumber.classList.remove('text-gray-700');
                            mainNumber.classList.add('text-white', numberColor, 'scale-105');
                            setTimeout(() => {
                                mainNumber.classList.remove('scale-105'); 
                            }, animationDuration); 
                        }
                    }
                }
            }
        }, delay > 0 ? delay : 0);
    }

    function showVisualization() {
        if (!isPlaying || isFullscreenDisabled) return; 
        clearTimeout(autoFullscreenTimeout); 
        isVisualizationMode = true;
        appWrapper.classList.add('hidden'); 
        visualizationScreen.classList.remove('hidden');
        
        document.querySelectorAll('.beat-number-main').forEach(textEl => {
            textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
            textEl.classList.add('text-gray-700');
        });
        document.querySelectorAll('.beat-quadrant').forEach(quadrant => {
            quadrant.classList.remove('bg-[#4a4768]');
        });
    }

    window.hideVisualization = function() {
        isVisualizationMode = false;
        visualizationScreen.classList.add('hidden');
        appWrapper.classList.remove('hidden'); 
        document.querySelectorAll('.beat-number-main').forEach(textEl => {
            textEl.classList.remove('text-white', 'scale-105', 'text-red-400', 'text-[#9a7dff]');
            textEl.classList.add('text-gray-700');
        });
        document.querySelectorAll('.beat-quadrant').forEach(quadrant => {
            quadrant.classList.remove('bg-[#4a4768]');
        });
        if (isPlaying && !isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout); 
            autoFullscreenTimeout = setTimeout(() => {
                showVisualization();
            }, AUTO_FULLSCREEN_DELAY); 
        }
    }

    window.toggleFullscreenLock = function() {
        isFullscreenDisabled = !isFullscreenDisabled;
        if (isFullscreenDisabled) {
            fullscreenIconContainer.innerHTML = SVG_EYE_CLOSED; 
            fullscreenIconContainer.classList.remove('text-gray-400'); 
            fullscreenIconContainer.classList.add('text-[#9a7dff]'); 
            fullscreenLockToggle.classList.remove('bg-[#4a4768]');
            fullscreenLockToggle.classList.add('bg-[#6a5acd]'); 
            fullscreenLockToggle.title = 'è§£é–è‡ªå‹•å…¨è¢å¹• (F)';
            clearTimeout(autoFullscreenTimeout); 
            if (isVisualizationMode) hideVisualization();
        } else {
            fullscreenIconContainer.innerHTML = SVG_EYE_OPEN; 
            fullscreenIconContainer.classList.remove('text-[#9a7dff]'); 
            fullscreenIconContainer.classList.add('text-gray-400'); 
            fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
            fullscreenLockToggle.classList.add('bg-[#4a4768]');
            fullscreenLockToggle.title = 'é–å®šè‡ªå‹•å…¨è¢å¹• (F)';
            if (isPlaying) hideVisualization(); 
        }
    }

    visualizationScreen.addEventListener('click', () => { hideVisualization(); });

    window.startStop = function() {
        initializeAudio();
        if (isPlaying) {
            clearInterval(intervalTimer);
            isPlaying = false;
            hideVisualization(); 
            clearTimeout(autoFullscreenTimeout); 
            startButton.textContent = 'é–‹å§‹';
            startButton.classList.remove('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');
            startButton.classList.add('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            
            // é‡ç½®é¡è‰²
            beatIndicatorsContainer.querySelectorAll('.beat-indicator').forEach((ind, index) => {
                ind.classList.remove('bg-[#ff5733]', 'bg-[#ffc300]', 'scale-110');
                if (beatSubdivisions[index] !== 4) {
                    ind.classList.add('bg-gray-600');
                    ind.classList.remove('bg-gray-900', 'opacity-50');
                } else {
                     ind.classList.add('bg-gray-900', 'opacity-50');
                     ind.classList.remove('bg-gray-600');
                }
            });
            
            currentBeat = 0;
        } else {
            if (audioContext.state === 'suspended') { audioContext.resume(); }
            isPlaying = true;
            startButton.textContent = 'åœæ­¢';
            startButton.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-700');
            startButton.classList.add('bg-red-500', 'hover:bg-red-600', 'focus:ring-red-700');
            currentBeat = 0;
            nextNoteTime = audioContext.currentTime;
            if (!isFullscreenDisabled) { setTimeout(showVisualization, 1000); }
            intervalTimer = setInterval(scheduler, lookahead);
        }
    }

    window.updateBPM = function(newBPM) {
        const parsedBPM = parseInt(newBPM, 10);
        if (isNaN(parsedBPM)) return;
        let clampedBPM = Math.max(40, Math.min(240, parsedBPM));
        bpm = clampedBPM;
        bpmDisplay.textContent = bpm;
        bpmInput.value = bpm;
    }

    window.changeBPM = function(delta) {
        let newBPM = bpm + delta;
        updateBPM(newBPM);
    }

    window.handleTap = function() {
        const now = Date.now();
        let calculatedBPM = null;
        let infoMessage = 'é»æ“Šæ­¤è™•æˆ–æŒ‰ [ç©ºç™½éµ] ä¾†åµæ¸¬ç¯€æ‹';
        if (tapHistory.length > 0) {
            const lastTap = tapHistory[tapHistory.length - 1];
            const interval = now - lastTap;
            if (interval > TAP_RESET_THRESHOLD) {
                tapHistory = [now]; 
                infoMessage = "åµæ¸¬é–‹å§‹... (å·²é‡ç½®)";
                tapTempoInfo.textContent = infoMessage;
                return;
            }
            tapHistory.push(now);
            if (tapHistory.length > 8) { tapHistory.shift(); }
            if (tapHistory.length >= 2) {
                let totalInterval = 0;
                for (let i = 1; i < tapHistory.length; i++) {
                    totalInterval += tapHistory[i] - tapHistory[i - 1];
                }
                const averageInterval = totalInterval / (tapHistory.length - 1);
                calculatedBPM = Math.round(60000 / averageInterval);
                infoMessage = `æœ€è¿‘ ${tapHistory.length - 1} æ¬¡é–“éš”çš„å¹³å‡ BPMï¼š${calculatedBPM}`;
            }
        } else {
            tapHistory.push(now);
            infoMessage = "åµæ¸¬é–‹å§‹... (è«‹é»æ“Šç¬¬äºŒæ¬¡)";
        }
        if (calculatedBPM !== null) {
            const clampedBPM = Math.max(40, Math.min(240, calculatedBPM));
            updateBPM(clampedBPM);
        }
        tapTempoInfo.textContent = infoMessage;
    };

    window.toggleDrumMode = function() {
        isDrumMode = !isDrumMode;
        if (isDrumMode) {
            drumIcon.classList.remove('text-gray-400');
            drumIcon.classList.add('text-[#ffc300]'); 
            drumModeToggle.classList.remove('bg-[#4a4768]');
            drumModeToggle.classList.add('bg-[#6a5acd]'); 
            drumModeToggle.title = 'åˆ‡æ›è‡³ç¯€æ‹å™¨æ¨¡å¼ (D)';
        } else {
            drumIcon.classList.remove('text-[#ffc300]');
            drumIcon.classList.add('text-gray-400');
            drumModeToggle.classList.remove('bg-[#6a5acd]');
            drumModeToggle.classList.add('bg-[#4a4768]');
            drumModeToggle.title = 'åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)';
        }
        if (isPlaying) { window.startStop(); window.startStop(); }
    }

    function updateSubdivisionLabels() {
        const indicators = document.querySelectorAll('.beat-indicator');
        indicators.forEach((indicator, index) => {
            if (index >= beatSubdivisions.length) return; 
            const mode = beatSubdivisions[index];
            const modeTextSpan = indicator.querySelector('.mode-text');
            indicator.classList.remove('bg-gray-900', 'opacity-50');
            indicator.classList.add('bg-gray-600');
            if (modeTextSpan) modeTextSpan.innerHTML = SUBDIVISION_LABELS[mode];
            if (mode === 4) {
                indicator.classList.remove('bg-gray-600');
                indicator.classList.add('bg-gray-900', 'opacity-50');
            }
        });
    }

    window.toggleSubdivision = function(beatIndex) {
        initializeAudio(); 
        let currentMode = beatSubdivisions[beatIndex];
        let newMode = (currentMode + 1) % 5; 
        beatSubdivisions[beatIndex] = newMode;
        updateSubdivisionLabels();
        if (isPlaying) { window.startStop(); window.startStop(); }
    };

    appWrapper.addEventListener('mousemove', () => {
        if (isPlaying && !isVisualizationMode && !isFullscreenDisabled) {
            clearTimeout(autoFullscreenTimeout);
            autoFullscreenTimeout = setTimeout(() => {
                showVisualization();
            }, AUTO_FULLSCREEN_DELAY);
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.target.tagName === 'INPUT') return;
        if (isVisualizationMode && event.code !== 'Space' && event.code !== 'KeyD' && event.code !== 'KeyF') {
            event.preventDefault();
            hideVisualization();
            return;
        }
        if (event.code === 'Space') {
            event.preventDefault(); 
            handleTap();
        } else if (event.code === 'KeyD') {
            event.preventDefault(); 
            toggleDrumMode();
        } else if (event.code === 'KeyF') {
            event.preventDefault(); 
            toggleFullscreenLock();
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        updateBPM(bpm);
        drumModeToggle.title = 'åˆ‡æ›è‡³é¼“æ¨¡å¼ (D)';
        isFullscreenDisabled = false;
        fullscreenIconContainer.innerHTML = SVG_EYE_OPEN; 
        fullscreenIconContainer.classList.remove('text-[#9a7dff]'); 
        fullscreenIconContainer.classList.add('text-gray-400'); 
        fullscreenLockToggle.classList.remove('bg-[#6a5acd]');
        fullscreenLockToggle.classList.add('bg-[#4a4768]');
        fullscreenLockToggle.title = 'é–å®šè‡ªå‹•å…¨è¢å¹• (F)';
        
        // åˆå§‹æ¸²æŸ“ UI (Beat indicators)
        renderUI();
        setCardPosition(0);
    });
</script>

</body>
</html>
